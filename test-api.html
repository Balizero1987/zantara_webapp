<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZANTARA API Test</title>
    <script src="js/env.js"></script>
    <script src="js/api-config.js"></script>
    <style>
        body {
            font-family: monospace;
            background: #0a0a0a;
            color: #0f0;
            padding: 20px;
        }
        button {
            background: #0f0;
            color: #000;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        #output {
            background: #111;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #0f0;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
    </style>
</head>
<body>
    <h1>ðŸš€ ZANTARA API Test Console</h1>

    <div>
        <button onclick="testHealth()">Test Health</button>
        <button onclick="testTeamList()">Test Team List</button>
        <button onclick="testContactInfo()">Test Contact Info</button>
        <button onclick="testAIChat()">Test AI Chat</button>
        <button onclick="printTelemetry()" title="Show telemetry summary">Telemetry Summary</button>
    </div>

    <div style="margin-top:12px;">
        <input id="baseOverride" placeholder="Set API Base (e.g., https://zantara-v520-production-XXXX-ew.a.run.app)" style="width:100%;padding:8px;background:#111;border:1px solid #0f0;color:#0f0;" />
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
            <button onclick="setBaseFromInput()">Set Base</button>
            <button onclick="showCurrentBase()">Show Current Base</button>
        </div>
    </div>

    <h3 style="margin-top:16px;">Training + Integration Runner</h3>
    <div>
        <input id="testUserEmail" placeholder="test user email (default: localStorage or demo@zantara.com)" style="width:100%;padding:8px;background:#111;border:1px solid #0f0;color:#0f0;" />
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
            <button onclick="runTraining()">Run Training</button>
            <button onclick="runIntegrationTests()">Run Integration Tests</button>
            <button onclick="runAll()">Run All</button>
        </div>
    </div>

    <h3 style="margin-top:16px;">Google Workspace Tests (OAuth2/Impersonation required)</h3>
    <div>
        <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
            <input type="checkbox" id="includeGoogle" /> Include Google Workspace tests
        </label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button onclick="runGoogleTests()">Run Google Tests</button>
        </div>
        <p style="color:#aaa;margin-top:6px;font-size:12px;">Note: requires USE_OAUTH2=true, IMPERSONATE_USER configured, and Google credentials mounted on Cloud Run.</p>
    </div>

    <h3 style="margin-top:16px;">Custom Handler</h3>
    <div>
        <input id="handlerKey" placeholder="handler key (e.g., zantara.personality.profile)" style="width:100%;padding:8px;background:#111;border:1px solid #0f0;color:#0f0;" />
        <textarea id="handlerParams" placeholder='{"collaboratorId":"zero"}' style="width:100%;height:140px;margin-top:8px;padding:8px;background:#111;border:1px solid #0f0;color:#0f0;"></textarea>
        <button onclick="runCustom()">Run</button>
    </div>

    <div id="output"></div>

    <script>
        const API_BASE = (window.ZANTARA_PROXY_BASE || localStorage.getItem('zantara-proxy-base') || (window.ZANTARA_API && window.ZANTARA_API.config && window.ZANTARA_API.config.proxy && window.ZANTARA_API.config.proxy.production && window.ZANTARA_API.config.proxy.production.base) || '');

        function log(message, type = '') {
            const output = document.getElementById('output');
            const timestamp = new Date().toISOString();
            output.innerHTML += `<span class="${type}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        async function testHealth() {
            log('Testing /health endpoint...');
            try {
                let url = `${API_BASE}/health`;
                let resp = null;
                if (API_BASE) {
                  resp = await fetch(url);
                }
                if (!resp || !resp.ok) {
                  const backend = (window.ZANTARA_API && window.ZANTARA_API.config && window.ZANTARA_API.config.production && window.ZANTARA_API.config.production.base) || '';
                  if (backend) {
                    url = backend + '/health';
                    resp = await fetch(url);
                  }
                }
                if (!resp) throw new Error('No health endpoint reachable');
                const data = await resp.json();
                log('âœ… Health: ' + JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                log('âŒ Health error: ' + error.message, 'error');
            }
        }

        function setBaseFromInput() {
            const input = document.getElementById('baseOverride');
            const val = (input && input.value || '').trim();
            if (!val) return log('âš ï¸ Missing base URL', 'error');
            if (!/^https?:\/\//i.test(val)) return log('âŒ Invalid URL', 'error');
            try {
                window.ZANTARA_API.setBase(val);
                localStorage.setItem('zantara-api-base', val);
                log('ðŸ”§ Base set to: ' + val, 'success');
            } catch(e) {
                log('âŒ Failed to set base: ' + e.message, 'error');
            }
        }

        function showCurrentBase() {
            const viaHelper = !!(window.ZANTARA_API && window.ZANTARA_API.call);
            const helperBase = viaHelper ? (window.ZANTARA_API.config?.production?.base || 'unknown') : 'n/a';
            log('â„¹ï¸ Current Base: ' + helperBase);
        }

        function printTelemetry() {
            try {
                const t = (window.ZANTARA_TELEMETRY && window.ZANTARA_TELEMETRY.getSummary) ? window.ZANTARA_TELEMETRY.getSummary() : null;
                if (!t) return log('âŒ Telemetry not available', 'error');
                log('ðŸ“Š Telemetry Totals: ' + JSON.stringify(t.totals));
                const top = Object.entries(t.perKey).sort((a,b)=>b[1].count - a[1].count).slice(0,8);
                log('ðŸ“ˆ Top Keys:\n' + JSON.stringify(Object.fromEntries(top), null, 2));
            } catch (e) {
                log('âŒ Telemetry error: ' + e.message, 'error');
            }
        }

        async function testTeamList() {
            log('Testing team.list handler...');
            try {
                const data = window.ZANTARA_API && window.ZANTARA_API.call
                  ? await window.ZANTARA_API.call('/call', { key: 'team.list', params: {} }, true)
                  : await (await fetch(`${API_BASE}/call`, { method:'POST', headers:{'Content-Type':'application/json','x-user-id': (localStorage.getItem('zantara-user-email')||'') }, body: JSON.stringify({ key:'team.list', params:{} }) })).json();
                log('âœ… Team list: ' + JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                log('âŒ Team list error: ' + error.message, 'error');
            }
        }

        async function testContactInfo() {
            log('Testing contact.info handler...');
            try {
                const data = window.ZANTARA_API && window.ZANTARA_API.call
                  ? await window.ZANTARA_API.call('/call', { key: 'contact.info', params: {} }, true)
                  : await (await fetch(`${API_BASE}/call`, { method:'POST', headers:{'Content-Type':'application/json','x-user-id': (localStorage.getItem('zantara-user-email')||'') }, body: JSON.stringify({ key:'contact.info', params:{} }) })).json();
                log('âœ… Contact info: ' + JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                log('âŒ Contact info error: ' + error.message, 'error');
            }
        }

        async function testAIChat() {
            log('Testing AI chat endpoint...');
            try {
                const data = window.ZANTARA_API && window.ZANTARA_API.call
                  ? await window.ZANTARA_API.call('/call', { key: 'ai.chat', params: { prompt: 'Hello, test from ZANTARA console'} }, true)
                  : await (await fetch(`${API_BASE}/call`, { method:'POST', headers:{'Content-Type':'application/json','x-user-id': (localStorage.getItem('zantara-user-email')||'') }, body: JSON.stringify({ key:'ai.chat', params:{ prompt: 'Hello, test from ZANTARA console'} }) })).json();
                log('âœ… AI response: ' + JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                log('âŒ AI chat error: ' + error.message, 'error');
            }
        }

        async function runCustom() {
            const key = document.getElementById('handlerKey').value.trim();
            const raw = document.getElementById('handlerParams').value.trim();
            if (!key) {
                return log('âŒ Please enter a handler key', 'error');
            }
            let params = {};
            try { params = raw ? JSON.parse(raw) : {}; } catch (e) { return log('âŒ Invalid JSON params: ' + e.message, 'error'); }
            log(`Running handler: ${key}`);
            try {
                const data = window.ZANTARA_API && window.ZANTARA_API.call
                  ? await window.ZANTARA_API.call('/call', { key, params }, true)
                  : await (await fetch(`${API_BASE}/call`, { method:'POST', headers:{'Content-Type':'application/json','x-user-id': (localStorage.getItem('zantara-user-email')||'') }, body: JSON.stringify({ key, params }) })).json();
                log('âœ… Result: ' + JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                log('âŒ Custom error: ' + error.message, 'error');
            }
        }

        async function runTraining() {
            log('â–¶ Training: start');
            const api = window.ZANTARA_API;
            if (!api || !api.call) return log('âŒ ZANTARA_API not found', 'error');
            const emailInput = (document.getElementById('testUserEmail') || {}).value || '';
            const userEmail = emailInput || localStorage.getItem('zantara-user-email') || 'demo@zantara.com';
            const userId = (userEmail.split('@')[0]) || 'demo';
            const channel = 'webapp.training';
            const sessions = [
              { facts:['Lang: IT','Track: visa','Team prefer sprint breve','Anton/Krishna: checklist forte'], sum:'Scadenza KITAS: sprint breve 2+2 con backup; focus su sponsor/biometria/fee.', sig:'attune', track:'visa', intent:'zantara.attune' },
              { facts:['Project: visa automation','Zero: scope','Adit: ops lead','Krishna: QA'], sum:'Triade scopeâ†’opsâ†’QA in sprint 48h; DoD + QA gates riducono edge-cases.', sig:'synergy', track:'relationship', intent:'zantara.synergy.map' },
              { facts:['Ari: process leader','Anton: risk-aware','Team accetta test A/B'], sum:'Conflitto trasformato in A/B con metriche; decisione in 24h.', sig:'mediate', track:'relationship', intent:'zantara.conflict.mediate' },
              { facts:['Prefers WIPâ‰¤3','Deep-work blocks help','Short daily rituals'], sum:'Piano mensile: WIP limits, deep-work, run-rate/rework; 10â€™ daily / 30â€™ weekly retro.', sig:'optimize', track:'performance', intent:'zantara.performance.optimization' },
              { facts:['Celebrations brief & specific','Team recognizes roles'], sum:'Celebrazione batch B211 con ringraziamenti mirati e sticker â€œBatch Masterâ€.', sig:'celebrate', track:'relationship', intent:'zantara.celebration.orchestrate' },
              { facts:['Client prefers EN','Interested: B211A','Follow-up next day'], sum:'Richiesta B211A $650; lead salvato con follow-up EN domani su slot breve.', sig:'lead', track:'visa', intent:'lead.save' },
              { facts:['Client sensitive to timelines','Weekly cadence, single owner'], sum:'Recovery: apology + plan + weekly updates; owner chiaro.', sig:'relationship', track:'relationship', intent:'zantara.client.relationship.intelligence' }
            ];
            const call = (key, params) => api.call('/call', { key, params }, true);
            let ok = 0, err = 0;
            for (const s of sessions) {
                try {
                    const res = await call('memory.save', {
                        userId, channel,
                        profile_facts: s.facts,
                        summary: s.sum,
                        relationship_signal: s.sig,
                        last_intent: s.intent,
                        current_track: s.track
                    });
                    if (res && (res.ok || res.status === 200)) { ok++; log('âœ… memory.save: ' + s.intent, 'success'); }
                    else { err++; log('âŒ memory.save: ' + (res?.error || 'unknown'), 'error'); }
                    await new Promise(r => setTimeout(r, 150));
                } catch (e) { err++; log('âŒ memory.save error: ' + e.message, 'error'); }
            }
            log(`ðŸ Training completed: OK=${ok}, ERR=${err}`, err ? 'error' : 'success');
        }

        async function runIntegrationTests() {
            log('â–¶ Integration tests: start');
            const api = window.ZANTARA_API;
            if (!api || !api.call) return log('âŒ ZANTARA_API not found', 'error');
            const call = (key, params={}) => api.call('/call', { key, params }, true);
            const emailInput = (document.getElementById('testUserEmail') || {}).value || '';
            const email = emailInput || localStorage.getItem('zantara-user-email') || 'zero@balizero.com';
            const me = (email.split('@')[0]) || 'zero';

            const tests = [
              { name:'identity', key:'identity.resolve', params:{ email } },
              { name:'contact.info', key:'contact.info', params:{} },
              { name:'ai.chat', key:'ai.chat', params:{ prompt:'Quick connectivity check.' } },
              { name:'pricing', key:'bali.zero.pricing', params:{ service:'visa' } },
              { name:'lead.save', key:'lead.save', params:{ name:'Test User', email:'test@example.com', nationality:'US', urgency:'normal', service:'visa' } },
              { name:'personality.profile', key:'zantara.personality.profile', params:{ collaboratorId: me, assessment_context:'webapp_test', force_refresh:false } },
              { name:'attune', key:'zantara.attune', params:{ collaboratorId: me, interaction_context:'webapp_test', emotional_state:'neutral', communication_preference:'direct_with_empathy' } },
              { name:'synergy.map', key:'zantara.synergy.map', params:{ project_context:'visa_automation', team_members:[me,'adit','krishna'], deadline_pressure:'high', complexity:'complex' } },
              { name:'dashboard.overview', key:'zantara.dashboard.overview', params:{} },
              { name:'communication.adapt', key:'zantara.communication.adapt', params:{ collaboratorId: me, message_content:'Meeting postponed due to client emergency', audience:'internal', tone_preference:'professional_empathetic' } },
              { name:'conflict.mediate', key:'zantara.conflict.mediate', params:{ involved_parties:[me,'anton'], conflict_context:'approach disagreement', severity_level:'moderate' } },
              { name:'growth.track', key:'zantara.growth.track', params:{ collaboratorId: me, timeframe:'last_quarter', include_recommendations:true } },
              { name:'celebration.orchestrate', key:'zantara.celebration.orchestrate', params:{ achievement_type:'batch_b211_success', involved_members:[me,'adit','krishna'], celebration_scale:'team', personalization_level:'enhanced' } }
            ];

            // Optionally include Google tests at the end
            if ((document.getElementById('includeGoogle')||{}).checked) {
                tests.push(
                  { name:'calendar.create', key:'calendar.create', params:{ event:{ summary:'ZANTARA Test', description:'Created by ZANTARA Webapp', start:{ dateTime:new Date(Date.now()+3600e3).toISOString(), timeZone:'Asia/Jakarta' }, end:{ dateTime:new Date(Date.now()+7200e3).toISOString(), timeZone:'Asia/Jakarta' }, attendees:[{email}], reminders:{useDefault:false, overrides:[{method:'popup', minutes:10}] } } } },
                  { name:'docs.create', key:'docs.create', params:{ title:'ZANTARA Web Test Doc', body:{ content:[{ paragraph:{ elements:[{ textRun:{ content:'Titolo\n', textStyle:{ bold:true } } }] } }, { paragraph:{ elements:[{ textRun:{ content:'Contenuto...' } }] } }] } } },
                  { name:'sheets.create', key:'sheets.create', params:{ title:'ZANTARA Web Test Sheet', sheets:[{ properties:{ title:'Foglio1', gridProperties:{ rowCount:100, columnCount:10 } } }] } },
                  { name:'drive.list', key:'drive.list', params:{ pageSize: 5, supportsAllDrives:true } }
                );
            }

            let ok = 0, err = 0;
            for (const t of tests) {
                try {
                    const res = await call(t.key, t.params);
                    if (res && (res.ok || res.status === 200)) { ok++; log(`âœ… ${t.name}`, 'success'); }
                    else { err++; log(`âŒ ${t.name}: ${res?.error || 'unknown'}`, 'error'); }
                    await new Promise(r => setTimeout(r, 150));
                } catch (e) { err++; log(`âŒ ${t.name}: ${e.message}`, 'error'); }
            }
            log(`ðŸ Integration tests completed: OK=${ok}, ERR=${err}`, err ? 'error' : 'success');
            // Print telemetry summary after integration
            printTelemetry();
        }

        async function runAll() {
            try {
                await runTraining();
            } catch (e) {
                log('âš ï¸ Training error (continuo comunque): ' + e.message, 'error');
            }
            await new Promise(r => setTimeout(r, 300));
            try {
                await runIntegrationTests();
            } catch (e) {
                log('âŒ Integration error: ' + e.message, 'error');
            }
        }

        async function runGoogleTests() {
            const checked = (document.getElementById('includeGoogle')||{}).checked;
            if (!checked) return log('âš ï¸ Enable the checkbox to run Google tests', 'error');
            const api = window.ZANTARA_API;
            if (!api || !api.call) return log('âŒ ZANTARA_API not found', 'error');
            const call = (k,p={})=>api.call('/call',{key:k,params:p},true);
            const email = localStorage.getItem('zantara-user-email') || 'zero@balizero.com';
            const tests = [
              { name:'calendar.create', key:'calendar.create', params:{ event:{ summary:'ZANTARA Test', description:'Created by ZANTARA Webapp', start:{ dateTime:new Date(Date.now()+3600e3).toISOString(), timeZone:'Asia/Jakarta' }, end:{ dateTime:new Date(Date.now()+7200e3).toISOString(), timeZone:'Asia/Jakarta' }, attendees:[{email}], reminders:{useDefault:false, overrides:[{method:'popup', minutes:10}] } } } },
              { name:'docs.create', key:'docs.create', params:{ title:'ZANTARA Web Test Doc', body:{ content:[{ paragraph:{ elements:[{ textRun:{ content:'Titolo\n', textStyle:{ bold:true } } }] } }, { paragraph:{ elements:[{ textRun:{ content:'Contenuto...' } }] } }] } } },
              { name:'sheets.create', key:'sheets.create', params:{ title:'ZANTARA Web Test Sheet', sheets:[{ properties:{ title:'Foglio1', gridProperties:{ rowCount:100, columnCount:10 } } }] } },
              { name:'drive.list', key:'drive.list', params:{ pageSize: 5, supportsAllDrives:true } }
            ];
            let ok=0, err=0;
            for (const t of tests) {
                try { const r=await call(t.key, t.params); if (r?.ok) {ok++; log('âœ… '+t.name,'success');} else {err++; log('âŒ '+t.name+': '+(r?.error||'unknown'),'error');} await new Promise(r=>setTimeout(r,150)); }
                catch(e){err++; log('âŒ '+t.name+': '+e.message,'error');}
            }
            log(`ðŸ Google tests completed: OK=${ok}, ERR=${err}`, err ? 'error' : 'success');
        }

        // Auto-test health on load
        window.onload = () => {
            log('ZANTARA API Test Console Ready', 'success');
            const viaHelper = !!(window.ZANTARA_API && window.ZANTARA_API.call);
            const helperBase = viaHelper ? (window.ZANTARA_API.config?.production?.base || 'unknown') : 'n/a';
            log('Transport: ' + (viaHelper ? 'ZANTARA_API helper (CORS-aware)' : 'Direct fetch'));
            log('API (helper): ' + helperBase);
            log('API (fallback): ' + API_BASE);
            const user = localStorage.getItem('zantara-user-email') || '(unknown user)';
            log('User: ' + user);
            testHealth();
        };
    </script>
</body>
</html>
