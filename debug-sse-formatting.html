<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE Formatting Debug - ZANTARA</title>
    <script src="js/message-formatter.js"></script>
    <style>
        :root {
            --bg-primary: #000;
            --bg-secondary: #090920;
            --text-primary: #fff;
            --text-secondary: rgba(255,255,255,0.7);
            --border-light: rgba(255,255,255,0.1);
            --red: #ff0000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            padding: 2rem;
            line-height: 1.6;
        }

        h1 {
            color: var(--red);
            margin-bottom: 2rem;
            font-size: 1.8rem;
        }

        .section {
            margin-bottom: 3rem;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.5rem;
            background: var(--bg-secondary);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--red);
        }

        .raw-text {
            background: #000;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #0f0;
            max-height: 200px;
            overflow-y: auto;
        }

        .formatted-output {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            line-height: 1.5;
        }

        .html-code {
            background: #111;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #ff9;
            max-height: 300px;
            overflow-y: auto;
        }

        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .status-ok {
            background: rgba(0, 255, 0, 0.2);
            color: #0f0;
            border: 1px solid #0f0;
        }

        .status-error {
            background: rgba(255, 0, 0, 0.2);
            color: #f00;
            border: 1px solid #f00;
        }

        .test-button {
            background: var(--red);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
        }

        .test-button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <h1>üîç ZANTARA SSE Formatting Debug</h1>

    <div class="section">
        <div class="section-title">1. MessageFormatter Availability</div>
        <div id="formatter-status"></div>
    </div>

    <div class="section">
        <div class="section-title">2. Test: Simple Text with Double Newlines</div>
        <div class="status status-ok">Input contains \n\n (double newlines)</div>
        <div class="raw-text" id="test1-raw"></div>
        <div class="formatted-output" id="test1-output"></div>
        <div class="html-code" id="test1-html"></div>
    </div>

    <div class="section">
        <div class="section-title">3. Test: Markdown Header + Paragraphs</div>
        <div class="status status-ok">Input contains # header and \n\n paragraphs</div>
        <div class="raw-text" id="test2-raw"></div>
        <div class="formatted-output" id="test2-output"></div>
        <div class="html-code" id="test2-html"></div>
    </div>

    <div class="section">
        <div class="section-title">4. Test: Actual SSE Stream Simulation</div>
        <div class="status status-ok">Simulating token-by-token streaming like real SSE</div>
        <button class="test-button" onclick="simulateStreaming()">‚ñ∂Ô∏è Simulate Streaming</button>
        <div class="formatted-output" id="streaming-output" style="margin-top: 1rem; min-height: 100px;"></div>
        <div class="html-code" id="streaming-html" style="margin-top: 1rem;"></div>
    </div>

    <script>
        // Test 1: Simple text with double newlines
        const test1Text = "Questo √® il primo paragrafo con informazioni importanti sul KITAS.\n\nQuesto √® il secondo paragrafo che spiega i requisiti necessari per l'applicazione.\n\nQuesto √® il terzo paragrafo finale con le conclusioni.";

        // Test 2: Markdown header + paragraphs
        const test2Text = "# Processo KITAS Completo\n\nKITAS √® il permesso di soggiorno limitato per stranieri che lavorano o investono in Indonesia. La validit√† varia da 1 a 2 anni a seconda del tipo.\n\nBali Zero gestisce tutto il processo per te dal primo giorno. Prepariamo la documentazione completa e coordiniamo con l'ufficio immigrazione.";

        // Check formatter availability
        const formatterDiv = document.getElementById('formatter-status');
        if (typeof MessageFormatter !== 'undefined' && MessageFormatter.format) {
            formatterDiv.innerHTML = '<span class="status status-ok">‚úÖ MessageFormatter.format() available</span>';
        } else {
            formatterDiv.innerHTML = '<span class="status status-error">‚ùå MessageFormatter.format() NOT FOUND</span>';
        }

        // Test 1
        document.getElementById('test1-raw').textContent = test1Text;
        if (typeof MessageFormatter !== 'undefined') {
            const formatted1 = MessageFormatter.format(test1Text);
            document.getElementById('test1-output').innerHTML = formatted1;
            document.getElementById('test1-html').textContent = formatted1;
        }

        // Test 2
        document.getElementById('test2-raw').textContent = test2Text;
        if (typeof MessageFormatter !== 'undefined') {
            const formatted2 = MessageFormatter.format(test2Text);
            document.getElementById('test2-output').innerHTML = formatted2;
            document.getElementById('test2-html').textContent = formatted2;
        }

        // Test 3: Simulate streaming
        let streamingText = '';
        const streamChunks = [
            "# Il",
            " Processo",
            " KITAS",
            "\n\n",
            "KITAS √®",
            " il permesso",
            " di soggiorno",
            " limitato per",
            " stranieri che",
            " lavorano",
            " in Indonesia.",
            " La validit√†",
            " varia da",
            " 1 a 2",
            " anni.",
            "\n\n",
            "Bali Zero",
            " gestisce tutto",
            " per te.",
            " Prepariamo la",
            " documentazione",
            " completa e",
            " coordiniamo con",
            " l'ufficio",
            " immigrazione."
        ];

        async function simulateStreaming() {
            streamingText = '';
            const outputDiv = document.getElementById('streaming-output');
            const htmlDiv = document.getElementById('streaming-html');

            outputDiv.innerHTML = '<span style="color: rgba(255,255,255,0.5);">...</span>';

            for (let i = 0; i < streamChunks.length; i++) {
                streamingText += streamChunks[i];

                // Format the accumulated text
                const formatted = MessageFormatter.format(streamingText);
                outputDiv.innerHTML = formatted;
                htmlDiv.textContent = formatted;

                // Simulate delay between chunks
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        // Add inspection info
        console.log('=== ZANTARA SSE Debug ===');
        console.log('MessageFormatter available:', typeof MessageFormatter !== 'undefined');
        console.log('MessageFormatter.format available:', typeof MessageFormatter?.format === 'function');
        console.log('Test 1 text:', test1Text);
        console.log('Test 2 text:', test2Text);
    </script>
</body>
</html>
