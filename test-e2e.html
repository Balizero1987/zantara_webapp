<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#10b981">
    <title>ZANTARA E2E Test Suite</title>
    
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    
    <!-- API Layer -->
    <script src="js/zantara-api.js"></script>
    
    <!-- Test Modules -->
    <script src="js/core/error-handler.js"></script>
    <script src="js/core/cache-manager.js"></script>
    <script src="js/core/request-deduplicator.js"></script>
    <script src="js/sse-client.js"></script>
    <script src="js/conversation-persistence.js"></script>
    <script src="js/storage-manager.js"></script>
    <script src="js/zantara-knowledge.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .test-subtitle {
            color: #666;
            font-size: 1.1rem;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            border-left: 4px solid #667eea;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .test-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .test-results {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .test-result {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
        }
        
        .test-pass {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid #10b981;
            color: #065f46;
        }
        
        .test-fail {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }
        
        .test-info {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
            color: #1e40af;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .run-all-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 30px;
        }
        
        .run-all-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(16, 185, 129, 0.3);
        }
        
        .run-all-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1 class="test-title">ZANTARA E2E Test Suite</h1>
            <p class="test-subtitle">Test completo di tutti i moduli integrati</p>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <button class="run-all-btn" onclick="runAllTests()" id="runAllBtn">
            üöÄ Esegui Tutti i Test
        </button>
        
        <div class="test-section">
            <h2 class="section-title">üîê Authentication Tests</h2>
            <div class="test-grid">
                <button class="test-button" onclick="testLogin()">Test Login</button>
                <button class="test-button" onclick="testLogout()">Test Logout</button>
                <button class="test-button" onclick="testAuthGuard()">Test Auth Guard</button>
                <button class="test-button" onclick="testJWTValidation()">Test JWT</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2 class="section-title">üí¨ Chat & Communication Tests</h2>
            <div class="test-grid">
                <button class="test-button" onclick="testChatSend()">Test Send Message</button>
                <button class="test-button" onclick="testSSEStreaming()">Test SSE Streaming</button>
                <button class="test-button" onclick="testConversationPersistence()">Test Conversation Save</button>
                <button class="test-button" onclick="testWebSocket()">Test WebSocket</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2 class="section-title">üß† AI & Knowledge Tests</h2>
            <div class="test-grid">
                <button class="test-button" onclick="testZantaraKnowledge()">Test ZANTARA Knowledge</button>
                <button class="test-button" onclick="testAIResponse()">Test AI Response</button>
                <button class="test-button" onclick="testToolCalling()">Test Tool Calling</button>
                <button class="test-button" onclick="testRAGQuery()">Test RAG Query</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2 class="section-title">üìä Analytics & Dashboard Tests</h2>
            <div class="test-grid">
                <button class="test-button" onclick="testDashboard()">Test Dashboard</button>
                <button class="test-button" onclick="testTeamTracking()">Test Team Tracking</button>
                <button class="test-button" onclick="testAnalytics()">Test Analytics</button>
                <button class="test-button" onclick="testMetrics()">Test Metrics</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2 class="section-title">‚ö° Performance & Storage Tests</h2>
            <div class="test-grid">
                <button class="test-button" onclick="testCacheManager()">Test Cache</button>
                <button class="test-button" onclick="testStorageManager()">Test Storage</button>
                <button class="test-button" onclick="testRequestDeduplication()">Test Dedup</button>
                <button class="test-button" onclick="testErrorHandling()">Test Error Handler</button>
            </div>
        </div>
        
        <div class="test-results" id="testResults">
            <div class="test-result test-info">
                üéØ Test Suite pronta. Clicca "Esegui Tutti i Test" per iniziare.
            </div>
        </div>
    </div>
    
    <script>
        let testResults = [];
        let totalTests = 0;
        let passedTests = 0;
        
        // Test functions
        async function testLogin() {
            addTestResult('üîê Testing Login...', 'info');
            try {
                const result = await ZANTARA_API.teamLogin('zero@balizero.com', '010719');
                if (result.success) {
                    addTestResult('‚úÖ Login successful', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå Login failed: ' + result.error, 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå Login error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testLogout() {
            addTestResult('üîê Testing Logout...', 'info');
            try {
                const result = await ZANTARA_API.logout();
                addTestResult('‚úÖ Logout successful', 'pass');
                passedTests++;
            } catch (error) {
                addTestResult('‚ùå Logout error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testAuthGuard() {
            addTestResult('üîê Testing Auth Guard...', 'info');
            try {
                const isLoggedIn = ZANTARA_API.isLoggedIn();
                if (typeof isLoggedIn === 'boolean') {
                    addTestResult('‚úÖ Auth Guard working', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå Auth Guard not working', 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå Auth Guard error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testJWTValidation() {
            addTestResult('üîê Testing JWT Validation...', 'info');
            try {
                const token = localStorage.getItem('zantara-auth-token');
                if (token) {
                    addTestResult('‚úÖ JWT Token found', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå JWT Token not found', 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå JWT Validation error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testChatSend() {
            addTestResult('üí¨ Testing Chat Send...', 'info');
            try {
                const result = await ZANTARA_API.sendMessage('Test message from E2E');
                if (result.success) {
                    addTestResult('‚úÖ Chat send successful', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå Chat send failed: ' + result.error, 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå Chat send error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testSSEStreaming() {
            addTestResult('üí¨ Testing SSE Streaming...', 'info');
            try {
                if (window.SSEClient) {
                    addTestResult('‚úÖ SSE Client available', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå SSE Client not available', 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå SSE Streaming error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testConversationPersistence() {
            addTestResult('üí¨ Testing Conversation Persistence...', 'info');
            try {
                if (window.ConversationPersistence) {
                    addTestResult('‚úÖ Conversation Persistence available', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå Conversation Persistence not available', 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå Conversation Persistence error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testWebSocket() {
            addTestResult('üí¨ Testing WebSocket...', 'info');
            try {
                if (window.WebSocketManager) {
                    addTestResult('‚úÖ WebSocket Manager available', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå WebSocket Manager not available', 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå WebSocket error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testZantaraKnowledge() {
            addTestResult('üß† Testing ZANTARA Knowledge...', 'info');
            try {
                if (window.ZantaraKnowledge) {
                    addTestResult('‚úÖ ZANTARA Knowledge available', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå ZANTARA Knowledge not available', 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå ZANTARA Knowledge error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testAIResponse() {
            addTestResult('üß† Testing AI Response...', 'info');
            try {
                const result = await ZANTARA_API.call('ai.chat', { message: 'Hello ZANTARA' });
                if (result.success) {
                    addTestResult('‚úÖ AI Response successful', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå AI Response failed: ' + result.error, 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå AI Response error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testToolCalling() {
            addTestResult('üß† Testing Tool Calling...', 'info');
            try {
                const result = await ZANTARA_API.call('system.handlers.list');
                if (result.success) {
                    addTestResult('‚úÖ Tool Calling successful', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå Tool Calling failed: ' + result.error, 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå Tool Calling error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testRAGQuery() {
            addTestResult('üß† Testing RAG Query...', 'info');
            try {
                const result = await ZANTARA_API.call('rag.query', { query: 'Test query' });
                if (result.success) {
                    addTestResult('‚úÖ RAG Query successful', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå RAG Query failed: ' + result.error, 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå RAG Query error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testDashboard() {
            addTestResult('üìä Testing Dashboard...', 'info');
            try {
                if (window.RealZeroDashboard) {
                    addTestResult('‚úÖ Dashboard available', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå Dashboard not available', 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå Dashboard error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testTeamTracking() {
            addTestResult('üìä Testing Team Tracking...', 'info');
            try {
                if (window.RealTeamTracking) {
                    addTestResult('‚úÖ Team Tracking available', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå Team Tracking not available', 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå Team Tracking error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testAnalytics() {
            addTestResult('üìä Testing Analytics...', 'info');
            try {
                if (window.ZeroIntelligentAnalytics) {
                    addTestResult('‚úÖ Analytics available', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå Analytics not available', 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå Analytics error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testMetrics() {
            addTestResult('üìä Testing Metrics...', 'info');
            try {
                const result = await ZANTARA_API.call('analytics.overview');
                if (result.success) {
                    addTestResult('‚úÖ Metrics successful', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå Metrics failed: ' + result.error, 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå Metrics error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testCacheManager() {
            addTestResult('‚ö° Testing Cache Manager...', 'info');
            try {
                if (window.CacheManager) {
                    addTestResult('‚úÖ Cache Manager available', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå Cache Manager not available', 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå Cache Manager error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testStorageManager() {
            addTestResult('‚ö° Testing Storage Manager...', 'info');
            try {
                if (window.StorageManager) {
                    addTestResult('‚úÖ Storage Manager available', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå Storage Manager not available', 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå Storage Manager error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testRequestDeduplication() {
            addTestResult('‚ö° Testing Request Deduplication...', 'info');
            try {
                if (window.RequestDeduplicator) {
                    addTestResult('‚úÖ Request Deduplicator available', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå Request Deduplicator not available', 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå Request Deduplication error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        async function testErrorHandling() {
            addTestResult('‚ö° Testing Error Handling...', 'info');
            try {
                if (window.ErrorHandler) {
                    addTestResult('‚úÖ Error Handler available', 'pass');
                    passedTests++;
                } else {
                    addTestResult('‚ùå Error Handler not available', 'fail');
                }
            } catch (error) {
                addTestResult('‚ùå Error Handling error: ' + error.message, 'fail');
            }
            updateProgress();
        }
        
        // Utility functions
        function addTestResult(message, type) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function updateProgress() {
            const progress = (passedTests / totalTests) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }
        
        async function runAllTests() {
            const runAllBtn = document.getElementById('runAllBtn');
            runAllBtn.disabled = true;
            runAllBtn.textContent = 'üîÑ Eseguendo Test...';
            
            // Clear previous results
            document.getElementById('testResults').innerHTML = '';
            testResults = [];
            totalTests = 0;
            passedTests = 0;
            
            addTestResult('üöÄ Iniziando E2E Test Suite...', 'info');
            
            // Define all tests
            const tests = [
                testLogin, testLogout, testAuthGuard, testJWTValidation,
                testChatSend, testSSEStreaming, testConversationPersistence, testWebSocket,
                testZantaraKnowledge, testAIResponse, testToolCalling, testRAGQuery,
                testDashboard, testTeamTracking, testAnalytics, testMetrics,
                testCacheManager, testStorageManager, testRequestDeduplication, testErrorHandling
            ];
            
            totalTests = tests.length;
            
            // Run tests sequentially
            for (const test of tests) {
                await test();
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between tests
            }
            
            // Final results
            const successRate = ((passedTests / totalTests) * 100).toFixed(1);
            addTestResult(`üéØ Test completati: ${passedTests}/${totalTests} (${successRate}%)`, 'info');
            
            if (passedTests === totalTests) {
                addTestResult('üéâ Tutti i test sono passati! Sistema completamente funzionale.', 'pass');
            } else {
                addTestResult(`‚ö†Ô∏è ${totalTests - passedTests} test falliti. Controlla i dettagli sopra.`, 'fail');
            }
            
            runAllBtn.disabled = false;
            runAllBtn.textContent = 'üöÄ Esegui Tutti i Test';
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('üéØ E2E Test Suite caricata. Pronta per i test.', 'info');
        });
    </script>
</body>
</html>