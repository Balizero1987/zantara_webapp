<!DOCTYPE html>
<html>
<head>
  <title>Test Send Message</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #222; color: #0f0; }
    .console { background: #000; border: 1px solid #0f0; padding: 10px; height: 400px; overflow-y: auto; }
    button { background: #0f0; color: #000; padding: 8px; margin: 5px; border: none; cursor: pointer; }
    input { background: #111; color: #0f0; border: 1px solid #0f0; padding: 8px; width: 300px; }
  </style>
</head>
<body>
  <h1>Test Send Message</h1>
  <div class="console" id="console"></div>

  <div>
    <input type="text" id="test-msg" value="Test message" placeholder="Message to send">
    <button onclick="testDirect()">Test Direct Send</button>
    <button onclick="testForm()">Test Form Submit</button>
    <button onclick="checkApp()">Check App Status</button>
    <button onclick="openSyncra()">Open Syncra</button>
  </div>

  <script>
    function log(msg) {
      const c = document.getElementById('console');
      const line = document.createElement('div');
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      c.appendChild(line);
      c.scrollTop = c.scrollHeight;
    }

    function checkApp() {
      log('=== Checking App Status ===');

      // Open syncra in iframe to check
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = '/syncra.html';
      document.body.appendChild(iframe);

      iframe.onload = function() {
        try {
          const win = iframe.contentWindow;

          // Check if app exists
          if (win.zantaraApp) {
            log('✅ zantaraApp exists');

            // Check methods
            if (win.zantaraApp.sendMessage) {
              log('✅ sendMessage method exists');
            } else {
              log('❌ sendMessage method NOT FOUND');
            }

            // Check if initialized
            if (win.zantaraApp.messages) {
              log(`✅ App initialized with ${win.zantaraApp.messages.length} messages`);
            }

            // Check API
            if (win.ZANTARA_API) {
              log('✅ ZANTARA_API exists');
            } else {
              log('❌ ZANTARA_API NOT FOUND');
            }

          } else {
            log('❌ zantaraApp NOT FOUND - app not initialized');

            // Check if there's a login redirect
            if (win.location.href.includes('portal')) {
              log('⚠️ Redirected to portal - login required');
            }
          }

          // Check DOM elements
          const doc = iframe.contentDocument;
          const input = doc.getElementById('message-input');
          const button = doc.getElementById('send-button');
          const form = doc.getElementById('chat-form');

          log(`Input field: ${input ? '✅ exists' : '❌ NOT FOUND'}`);
          log(`Send button: ${button ? '✅ exists' : '❌ NOT FOUND'}`);
          log(`Form: ${form ? '✅ exists' : '❌ NOT FOUND'}`);

        } catch(e) {
          log(`Error: ${e.message}`);
        }

        document.body.removeChild(iframe);
      };
    }

    function testDirect() {
      log('Testing direct send...');
      const msg = document.getElementById('test-msg').value;

      // Try to call sendMessage directly
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = '/syncra.html';
      document.body.appendChild(iframe);

      iframe.onload = function() {
        try {
          const win = iframe.contentWindow;
          const doc = iframe.contentDocument;

          // Set message in input
          const input = doc.getElementById('message-input');
          if (input) {
            input.value = msg;
            log(`Set message: "${msg}"`);
          }

          // Try to send
          if (win.zantaraApp && win.zantaraApp.sendMessage) {
            win.zantaraApp.sendMessage();
            log('✅ Called sendMessage()');
          } else {
            log('❌ Cannot call sendMessage - app not ready');
          }

        } catch(e) {
          log(`Error: ${e.message}`);
        }

        setTimeout(() => document.body.removeChild(iframe), 1000);
      };
    }

    function testForm() {
      log('Testing form submit...');
      const msg = document.getElementById('test-msg').value;

      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = '/syncra.html';
      document.body.appendChild(iframe);

      iframe.onload = function() {
        try {
          const doc = iframe.contentDocument;

          // Set message
          const input = doc.getElementById('message-input');
          if (input) {
            input.value = msg;
            log(`Set message: "${msg}"`);
          }

          // Try form submit
          const form = doc.getElementById('chat-form');
          if (form) {
            const event = new Event('submit', { bubbles: true, cancelable: true });
            form.dispatchEvent(event);
            log('✅ Triggered form submit');
          } else {
            log('❌ No form found');
          }

        } catch(e) {
          log(`Error: ${e.message}`);
        }

        setTimeout(() => document.body.removeChild(iframe), 1000);
      };
    }

    function openSyncra() {
      window.open('/syncra.html', '_blank');
      log('Opened syncra in new window');
    }

    // Initial setup
    log('Test page ready');
    log('Set a test email to avoid redirect:');
    localStorage.setItem('zantara-user-email', 'test@example.com');
    log('Email set to test@example.com');
  </script>
</body>
</html>