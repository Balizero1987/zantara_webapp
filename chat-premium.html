<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ZANTARA // The Living Interface</title>
<link rel="stylesheet" href="tokens.css">
<style>
body{
  margin:0;
  background:radial-gradient(circle at 50% 50%,var(--bg-0) 0%,var(--bg-1) 100%);
  color:var(--text);
  font-family:Inter,system-ui,sans-serif;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  height:100vh;
}

/* === Header con logo e infinito === */
header{
  text-align:center;
  padding:24px 0 20px;
  border-bottom:1px solid rgba(199,167,94,.15);
  position:relative;
  user-select:none;
}
#header-inner{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:14px;
}
#logo{
  width:90px;
  opacity:.85;
  filter:drop-shadow(0 0 6px rgba(199,167,94,.25));
}
#title{
  font:600 13px "Playfair Display",serif;
  letter-spacing:.14em;
  color:var(--gold);
  text-transform:uppercase;
}

/* The Infinity Spine */
.infinity-spine {
  position: relative;
  width: 100%;
  height: 1px;
  background: linear-gradient(90deg, transparent, #d6b87a, transparent);
  margin: 20px 0;
  overflow: hidden;
}

.infinity-spine::before {
  content: '∞';
  position: absolute;
  left: 50%;
  top: -14px;
  transform: translateX(-50%);
  font-family: 'Orbitron', sans-serif;
  color: #d6b87a;
  font-size: 16px;
  opacity: 0.7;
  animation: fade-infinity 6s infinite ease-in-out;
}

@keyframes fade-infinity {
  0%, 100% { opacity: 0.3; transform: translateX(-50%) scale(1); }
  50% { opacity: 1; transform: translateX(-50%) scale(1.2); }
}

.pulse {
  position: absolute;
  left: 50%;
  top: 0;
  width: 2px;
  height: 1px;
  background: rgba(255, 215, 150, 0.6);
  box-shadow: 0 0 12px rgba(255, 215, 150, 0.8);
  transform: translateX(-50%);
  animation: pulse-move 3s infinite ease-in-out;
}

@keyframes pulse-move {
  0%, 100% { width: 2px; opacity: 0.6; }
  50% { width: 80px; opacity: 1; }
}

/* Sfondo "respiro" */
#bg{
  position:fixed;
  inset:0;
  z-index:-1;
  background:
    radial-gradient(circle at 30% 40%,rgba(199,167,94,.07),transparent 60%),
    radial-gradient(circle at 70% 75%,rgba(199,167,94,.05),transparent 80%);
  animation:drift 16s ease-in-out infinite alternate;
}
@keyframes drift{
  from{background-position:30% 40%,70% 75%}
  to{background-position:33% 38%,67% 78%}
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:radial-gradient(circle at center,rgba(199,167,94,.14) 0%,transparent 60%);
  opacity:.05;
  animation:breath 14s ease-in-out infinite;
  pointer-events:none;
}
@keyframes breath{
  0%,100%{transform:scale(1);opacity:.04}
  50%{transform:scale(1.05);opacity:.09}
}

/* === Chat area === */
#chat{
  flex:1;
  overflow:auto;
  scrollbar-width:none;
  padding:60px 12% 110px;
  position:relative;
}
#chat::-webkit-scrollbar{display:none}

.thinking{
  position:absolute;
  left:4%;
  top:20%;
  height:60%;
  width:2px;
  background:linear-gradient(to bottom,transparent 0%,rgba(199,167,94,.6) 35%,rgba(199,167,94,.9) 50%,rgba(199,167,94,.6) 65%,transparent 100%);
  opacity:0;
  transition:opacity .3s ease;
}
.message{
  margin:12px 0;
  max-width:80%;
  line-height:1.6;
  animation:fade .4s ease;
}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.user{
  align-self:flex-end;
  color:var(--text);
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.1);
  padding:10px 14px;
  border-radius:12px 12px 0 12px;
  margin-left:auto;
}
.zantara{
  align-self:flex-start;
  color:var(--text);
  border-left:2px solid var(--gold);
  padding:0 0 0 14px;
}
.zantara b{color:var(--gold)}

/* Smart Suggestions */
.suggestions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
  padding-left:14px;
}
.suggestion-pill{
  background:transparent;
  border:1px solid rgba(199,167,94,.4);
  color:var(--gold);
  padding:6px 12px;
  border-radius:16px;
  font-size:13px;
  cursor:pointer;
  transition:all .3s ease;
}
.suggestion-pill:hover{
  background:rgba(199,167,94,.1);
  border-color:var(--gold);
  box-shadow:0 0 8px rgba(199,167,94,.3);
}

/* === Barra input === */
#bar{
  position:sticky;
  bottom:0;
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  border-top:1px solid rgba(199,167,94,.15);
  background:linear-gradient(to bottom,transparent,rgba(10,10,18,.8));
  padding:22px 0 18px;
}
#suggest{
  position:absolute;
  bottom:70px;
  font-size:14px;
  color:rgba(199,167,94,.65);
  font-style:italic;
  opacity:0;
  transition:opacity 1s;
}
#suggest.active{text-shadow:0 0 10px rgba(199,167,94,.3);opacity:1}
#input{
  width:min(860px,76vw);
  padding:12px 18px;
  background:#12121A;
  border:1px solid var(--line);
  border-radius:28px;
  color:var(--text);
  outline:none;
}
#input:focus{
  border-color:var(--gold);
  box-shadow:0 0 10px rgba(199,167,94,.25);
}
#send{
  position:relative;
  margin-top:10px;
  background:var(--gold);
  color:var(--bg-0);
  border:none;
  border-radius:14px;
  padding:10px 18px;
  font-weight:700;
  cursor:pointer;
  transition:background .3s ease;
}
#send:hover{background:var(--gold-2)}

.def{
  border-bottom:1px dotted rgba(199,167,94,.6);
  cursor:help;
  position:relative;
}
.def:hover::after{
  content:attr(data-def);
  position:absolute;
  left:0;
  bottom:135%;
  background:#12121A;
  color:var(--text);
  border:1px solid rgba(199,167,94,.35);
  padding:8px 10px;
  border-radius:8px;
  white-space:nowrap;
  font-size:12px;
  box-shadow:0 6px 24px rgba(0,0,0,.35);
  z-index:10;
}
audio{display:none}
footer{
  text-align:center;
  font-size:11px;
  color:rgba(255,255,255,.3);
  letter-spacing:.05em;
  padding:10px 0 16px;
  border-top:1px solid rgba(199,167,94,.12);
}
</style>
</head>
<body>
<div id="bg" aria-hidden="true"></div>

<header>
  <div id="header-inner">
    <img id="logo" src="assets/balizero-logo-3d.png" alt="Bali Zero Logo">
    <div id="title">ZANTARA // LIVING INTERFACE</div>
  </div>
  <div class="infinity-spine">
    <span class="pulse"></span>
  </div>
</header>

<main id="chat" role="log" aria-live="polite" aria-busy="false">
  <div class="thinking" id="thinking"></div>
  <div class="message zantara">
    Ciao Zero.<br>
    Benvenuto nella stanza viva di <b>ZANTARA</b>. Qui il testo è il respiro del sistema.
  </div>
  <div class="message zantara">
    Il <span class="def" data-def="D12 Business Investigation: visto per ricerca mercato e investimenti, 60-180 giorni">D12 Visa</span> è pensato per chi esplora opportunità di investimento in Indonesia.<br>
    Permetto sopralluoghi, analisi di mercato e studi di fattibilità fino a <b>180 giorni</b>.
    <div class="suggestions">
      <button class="suggestion-pill">Quanto dura la procedura?</button>
      <button class="suggestion-pill">Quali altri visti esistono?</button>
      <button class="suggestion-pill">Mostrami la checklist ufficiale</button>
    </div>
  </div>
</main>

<section id="bar">
  <div id="suggest">Suggerimento: Vuoi sapere quanto dura la procedura di visto?</div>
  <input id="input" type="text" placeholder="Scrivi con calma, la mente ascolta…" autocomplete="off" aria-label="Messaggio a ZANTARA">
  <button id="send" aria-label="Invia">∞</button>
</section>

<footer>Bali Zero is powered by humans, fueled by a thinking engine.</footer>

<script src="js/zantara-api.js"></script>
<script src="js/sse-client.js"></script>
<script>
const chat = document.getElementById('chat');
const thinking = document.getElementById('thinking');
const input = document.getElementById('input');
const send = document.getElementById('send');
const suggest = document.getElementById('suggest');

const suggestions = [
  "Vuoi sapere quanto dura la procedura di visto?",
  "Serve la checklist documenti per C1, D12 o E33G?",
  "Vuoi confrontare KITAS investimento vs lavoro?",
  "Desideri esportare la risposta in PDF o Markdown?",
  "Posso mostrarti gli aggiornamenti normativi di oggi."
];

function cycleSuggestions(){
  let i=0;
  setInterval(()=>{
    suggest.textContent="Suggerimento: "+suggestions[i];
    suggest.classList.add('active');
    setTimeout(()=>suggest.classList.remove('active'),6000);
    i=(i+1)%suggestions.length;
  },8000);
}

function append(text,role='user'){
  const div=document.createElement('div');
  div.className=`message ${role}`;
  div.innerHTML=text;
  chat.appendChild(div);
  chat.scrollTo({top:chat.scrollHeight,behavior:'smooth'});
}

function setThinking(on){
  thinking.style.opacity=on?.75:0;
  chat.setAttribute('aria-busy',on?'true':'false');
}

async function handleSend(){
  const t=input.value.trim();
  if(!t)return;

  append(t,'user');
  input.value='';
  setThinking(true);

  try {
    const userEmail = localStorage.getItem('zantara-email') || 'zero@balizero.com';

    // Use SSE streaming if available
    if (window.ZANTARA_SSE && window.ZANTARA_SSE.stream) {
      let fullResponse = '';

      if (window.ZANTARA_SSE.removeAllListeners) {
        window.ZANTARA_SSE.removeAllListeners();
      }

      window.ZANTARA_SSE.on('start', () => {
        append('...', 'zantara');
      });

      window.ZANTARA_SSE.on('delta', ({message: chunk}) => {
        const lastMsg = chat.querySelector('.message.zantara:last-child');
        if (lastMsg) {
          lastMsg.innerHTML = '<b>ZANTARA:</b> ' + chunk;
        }
        fullResponse = chunk;
      });

      window.ZANTARA_SSE.on('complete', () => {
        setThinking(false);
        // Add smart suggestions
        const lastMsg = chat.querySelector('.message.zantara:last-child');
        if (lastMsg && fullResponse.includes('visto')) {
          const suggestDiv = document.createElement('div');
          suggestDiv.className = 'suggestions';
          suggestDiv.innerHTML = `
            <button class="suggestion-pill">Quali documenti servono?</button>
            <button class="suggestion-pill">Tempi di approvazione?</button>
            <button class="suggestion-pill">Costi totali?</button>
          `;
          lastMsg.appendChild(suggestDiv);

          // Add click handlers
          suggestDiv.querySelectorAll('.suggestion-pill').forEach(btn => {
            btn.addEventListener('click', () => {
              input.value = btn.textContent;
              handleSend();
            });
          });
        }
      });

      window.ZANTARA_SSE.on('error', (error) => {
        console.error('SSE Error:', error);
        append('<span style="color: #ff6b6b;">Errore di connessione. Riprova.</span>', 'zantara');
        setThinking(false);
      });

      await window.ZANTARA_SSE.stream(t, userEmail);

    } else {
      // Fallback to regular API
      const response = await ZANTARA_API.chat(t, userEmail);
      if (response.success) {
        append('<b>ZANTARA:</b> ' + response.response, 'zantara');
      } else {
        append('<span style="color: #ff6b6b;">Errore. Riprova.</span>', 'zantara');
      }
      setThinking(false);
    }
  } catch (error) {
    console.error('Error:', error);
    append('<span style="color: #ff6b6b;">Errore. Riprova.</span>', 'zantara');
    setThinking(false);
  }
}

send.addEventListener('click',handleSend);
input.addEventListener('keydown',e=>{if(e.key==='Enter' && !e.shiftKey){e.preventDefault();handleSend();}});

// Add click handlers to initial suggestion pills
document.querySelectorAll('.suggestion-pill').forEach(btn => {
  btn.addEventListener('click', () => {
    input.value = btn.textContent;
    handleSend();
  });
});

cycleSuggestions();
</script>
</body>
</html>
