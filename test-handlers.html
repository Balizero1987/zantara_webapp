<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZANTARA - Test Handlers</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1a0033 0%, #2D1B69 50%, #6B46C1 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }
        .test-button {
            background: #6B46C1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        .test-button:hover {
            background: #8B5CF6;
            transform: translateY(-2px);
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-left: 3px solid #10B981; }
        .error { border-left: 3px solid #EF4444; }
        .api-key-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: white;
        }
        h1 { text-align: center; }
        h2 { color: #E9D5FF; }
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
        }
        .status.ok { background: #10B981; }
        .status.fail { background: #EF4444; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå∏ ZANTARA Handler Test Suite</h1>

        <div class="test-section">
            <h2>Configuration</h2>
            <p>‚ö†Ô∏è In dev mode: x-api-key will be injected from localStorage</p>
            <input type="text"
                   id="apiKey"
                   class="api-key-input"
                   placeholder="Enter API Key (default: zantara-external-dev-key-2025)"
                   value="zantara-external-dev-key-2025">
            <button class="test-button" onclick="saveApiKey()">Save API Key to LocalStorage</button>
            <div id="configResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>Backend Health Check</h2>
            <button class="test-button" onclick="testHealth()">Test Health</button>
            <div id="healthResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>Memory System (Firestore)</h2>
            <button class="test-button" onclick="testMemorySave()">Save Memory</button>
            <button class="test-button" onclick="testMemoryRetrieve()">Retrieve Memory</button>
            <button class="test-button" onclick="testMemoryList()">List Memories</button>
            <div id="memoryResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>Google Workspace Handlers</h2>
            <button class="test-button" onclick="testDriveList()">Test Drive List</button>
            <button class="test-button" onclick="testCalendarList()">Test Calendar List</button>
            <button class="test-button" onclick="testContactsList()">Test Contacts List</button>
            <div id="workspaceResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>RAG / ChromaDB</h2>
            <button class="test-button" onclick="testRAGHealth()">RAG Health</button>
            <button class="test-button" onclick="testRAGSearch()">RAG Search</button>
            <button class="test-button" onclick="testBaliZeroChat()">Bali Zero Chat</button>
            <div id="ragResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>Bali Zero Handlers</h2>
            <button class="test-button" onclick="testContactInfo()">Contact Info</button>
            <button class="test-button" onclick="testPricing()">Pricing</button>
            <button class="test-button" onclick="testTeamList()">Team List</button>
            <div id="baliResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ZANTARA AI Handlers</h2>
            <button class="test-button" onclick="testZantaraDashboard()">ZANTARA Dashboard</button>
            <button class="test-button" onclick="testZantaraAttune()">ZANTARA Attune</button>
            <div id="zantaraResult" class="result"></div>
        </div>
    </div>

    <!-- Load API Config -->
    <script src="js/env.js"></script>
    <script src="js/api-config.js"></script>

    <script>
        // Save API key to localStorage for dev mode injection
        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value;
            localStorage.setItem('zantara-x-api-key', apiKey);
            document.getElementById('configResult').innerHTML =
                `<span class="status ok">OK</span> API Key saved to localStorage: ${apiKey}`;
        }

        // Helper to display results
        function displayResult(elementId, data, success = true) {
            const element = document.getElementById(elementId);
            element.className = `result ${success ? 'success' : 'error'}`;
            element.textContent = JSON.stringify(data, null, 2);
        }

        // Health Check
        async function testHealth() {
            try {
                const response = await fetch('https://zantara-v520-nuzantara-1064094238013.europe-west1.run.app/health');
                const data = await response.json();
                displayResult('healthResult', data, response.ok);
            } catch (error) {
                displayResult('healthResult', {error: error.message}, false);
            }
        }

        // Memory Tests
        async function testMemorySave() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'memory.save',
                    params: {
                        userId: 'test-webapp-user',
                        content: 'Test memory from webapp at ' + new Date().toISOString()
                    }
                });
                displayResult('memoryResult', data);
            } catch (error) {
                displayResult('memoryResult', {error: error.message}, false);
            }
        }

        async function testMemoryRetrieve() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'memory.retrieve',
                    params: { userId: 'test-webapp-user' }
                });
                displayResult('memoryResult', data);
            } catch (error) {
                displayResult('memoryResult', {error: error.message}, false);
            }
        }

        async function testMemoryList() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'memory.list',
                    params: {}
                });
                displayResult('memoryResult', data);
            } catch (error) {
                displayResult('memoryResult', {error: error.message}, false);
            }
        }

        // Google Workspace Tests
        async function testDriveList() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'drive.list',
                    params: {}
                });
                displayResult('workspaceResult', data);
            } catch (error) {
                displayResult('workspaceResult', {error: error.message}, false);
            }
        }

        async function testCalendarList() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'calendar.list',
                    params: {}
                });
                displayResult('workspaceResult', data);
            } catch (error) {
                displayResult('workspaceResult', {error: error.message}, false);
            }
        }

        async function testContactsList() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'contacts.list',
                    params: {}
                });
                displayResult('workspaceResult', data);
            } catch (error) {
                displayResult('workspaceResult', {error: error.message}, false);
            }
        }

        // RAG Tests
        async function testRAGHealth() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'rag.health',
                    params: {}
                });
                displayResult('ragResult', data);
            } catch (error) {
                displayResult('ragResult', {error: error.message}, false);
            }
        }

        async function testRAGSearch() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'rag.search',
                    params: {
                        query: 'visa requirements for indonesia',
                        k: 3
                    }
                });
                displayResult('ragResult', data);
            } catch (error) {
                displayResult('ragResult', {error: error.message}, false);
            }
        }

        async function testBaliZeroChat() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'bali.zero.chat',
                    params: {
                        query: 'What documents do I need for B211A visa?'
                    }
                });
                displayResult('ragResult', data);
            } catch (error) {
                displayResult('ragResult', {error: error.message}, false);
            }
        }

        // Bali Zero Tests
        async function testContactInfo() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'contact.info',
                    params: {}
                });
                displayResult('baliResult', data);
            } catch (error) {
                displayResult('baliResult', {error: error.message}, false);
            }
        }

        async function testPricing() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'pricing.official',
                    params: {
                        service: 'visa',
                        type: 'b211a'
                    }
                });
                displayResult('baliResult', data);
            } catch (error) {
                displayResult('baliResult', {error: error.message}, false);
            }
        }

        async function testTeamList() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'team.list',
                    params: {}
                });
                displayResult('baliResult', data);
            } catch (error) {
                displayResult('baliResult', {error: error.message}, false);
            }
        }

        // ZANTARA Tests
        async function testZantaraDashboard() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'zantara.dashboard.overview',
                    params: {
                        teamId: 'bali-zero'
                    }
                });
                displayResult('zantaraResult', data);
            } catch (error) {
                displayResult('zantaraResult', {error: error.message}, false);
            }
        }

        async function testZantaraAttune() {
            try {
                const data = await ZANTARA_API.call('/call', {
                    key: 'zantara.attune',
                    params: {
                        teamId: 'bali-zero',
                        focus: 'productivity'
                    }
                });
                displayResult('zantaraResult', data);
            } catch (error) {
                displayResult('zantaraResult', {error: error.message}, false);
            }
        }

        // Auto-save API key on load
        window.addEventListener('load', () => {
            const apiKey = document.getElementById('apiKey').value;
            if (apiKey) {
                saveApiKey();
            }
        });
    </script>
</body>
</html>
