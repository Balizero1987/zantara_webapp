<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZANTARA - Local Backend Test</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    .chat { border: 1px solid #ccc; padding: 20px; margin: 20px 0; min-height: 300px; max-height: 500px; overflow-y: auto; }
    .message { margin: 10px 0; padding: 10px; border-radius: 8px; }
    .user { background: #e3f2fd; text-align: right; }
    .assistant { background: #f5f5f5; }
    input { width: 70%; padding: 10px; font-size: 16px; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
    .success { background: #c8e6c9; }
    .error { background: #ffcdd2; }
  </style>
</head>
<body>
  <h1>üß™ ZANTARA - Local Backend Test</h1>
  <div class="status" id="status">Testing connection...</div>

  <h3>Your Identity</h3>
  <input type="email" id="email" placeholder="Your email" value="zero@balizero.com">
  <button onclick="setEmail()">Set Email</button>

  <h3>Chat</h3>
  <div class="chat" id="chat"></div>
  <input type="text" id="input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') send()">
  <button onclick="send()">Send</button>

  <script>
    const BACKEND = 'http://localhost:8080';
    const API_KEY = 'zantara-internal-dev-key-2025';
    let userEmail = 'zero@balizero.com';

    function setEmail() {
      userEmail = document.getElementById('email').value;
      localStorage.setItem('zantara-user-email', userEmail);
      addStatus('Email set to: ' + userEmail, 'success');
    }

    function addStatus(msg, type) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = 'status ' + type;
    }

    function addMessage(role, text) {
      const chat = document.getElementById('chat');
      const div = document.createElement('div');
      div.className = 'message ' + role;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function testHealth() {
      try {
        const res = await fetch(BACKEND + '/health');
        const data = await res.json();
        if (data.status === 'healthy') {
          addStatus('‚úÖ Backend healthy (v' + data.version + ')', 'success');
        } else {
          addStatus('‚ùå Backend unhealthy', 'error');
        }
      } catch (e) {
        addStatus('‚ùå Cannot connect to backend: ' + e.message, 'error');
      }
    }

    async function send() {
      const input = document.getElementById('input');
      const text = input.value.trim();
      if (!text) return;

      input.value = '';
      addMessage('user', text);

      try {
        const res = await fetch(BACKEND + '/call', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': API_KEY,
            'x-user-id': userEmail
          },
          body: JSON.stringify({
            key: 'ai.chat',
            params: {
              prompt: text,
              userId: userEmail,
              context: {
                userEmail: userEmail,
                userName: userEmail.split('@')[0]
              }
            }
          })
        });

        const data = await res.json();
        console.log('Response:', data);

        if (data.ok && data.data && data.data.response) {
          addMessage('assistant', data.data.response);
        } else {
          addMessage('assistant', 'Error: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        addMessage('assistant', '‚ùå Network error: ' + e.message);
        console.error(e);
      }
    }

    // Auto-load email from localStorage
    const saved = localStorage.getItem('zantara-user-email');
    if (saved) {
      userEmail = saved;
      document.getElementById('email').value = saved;
    }

    // Test connection on load
    testHealth();
  </script>
</body>
</html>