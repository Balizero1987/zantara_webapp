<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ZANTARA // Living Interface</title>
<link rel="stylesheet" href="tokens.css">
<script src="js/api-contracts.js"></script>
<script src="js/zantara-api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
body{margin:0;background:linear-gradient(180deg,var(--bg-0) 0%,var(--bg-1) 100%);color:var(--text);font:15px/1.7 Inter,system-ui,sans-serif;overflow:hidden;position:relative;height:100vh}
#bg{position:fixed;inset:0;z-index:-1;background:radial-gradient(circle at 30% 40%,rgba(199,167,94,.07),transparent 60%),radial-gradient(circle at 70% 75%,rgba(199,167,94,.05),transparent 80%);animation:drift 12s ease-in-out infinite alternate}
body::before{content:"";position:fixed;inset:0;background:radial-gradient(circle at center,rgba(199,167,94,.14) 0%,transparent 60%);opacity:.05;animation:breath 12s ease-in-out infinite}
@keyframes drift{0%{transform:translate(0,0) scale(1)}100%{transform:translate(-3%,4%) scale(1.02)}}
@keyframes breath{0%,100%{opacity:.03}50%{opacity:.08}}
@keyframes pulse{0%,100%{transform:scale(1);opacity:.8}50%{transform:scale(1.05);opacity:1}}
@keyframes fade{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}

.container{display:flex;flex-direction:column;height:100vh;max-width:1400px;margin:0 auto}
.title{text-align:center;padding:32px 20px 24px;color:var(--gold);font:600 14px/1 "Playfair Display",serif;letter-spacing:.2em;text-transform:uppercase}

#chat{flex:1;overflow-y:auto;padding:0 20px 20px;display:flex;flex-direction:column;gap:24px}

.msg{animation:fade .4s ease;position:relative}
.user-msg{display:flex;justify-content:flex-end;padding-right:40px}
.user-msg .bubble{padding:14px 20px;border-radius:18px 18px 4px 18px;background:rgba(199,167,94,.15);border:1px solid rgba(199,167,94,.25);color:var(--text);max-width:500px;font-size:15px}

.ai-msg{display:flex;justify-content:flex-start;padding-left:40px}
.ai-msg .content{border-left:3px solid var(--gold);padding:20px 24px;background:rgba(18,18,26,.6);backdrop-filter:blur(4px);border-radius:0 12px 12px 0;max-width:700px;color:var(--text)}
.ai-msg .content p{margin:0 0 14px;line-height:1.7}
.ai-msg .content p:last-child{margin:0}
.ai-msg .content strong{color:var(--gold);font-weight:600}
.ai-msg .content ul{margin:12px 0;padding-left:24px}
.ai-msg .content li{margin-bottom:8px;line-height:1.6}
.ai-msg .content code{background:rgba(199,167,94,.12);padding:2px 7px;border-radius:4px;font-family:monospace;font-size:13px;color:var(--gold)}

.suggestions{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
.sug-btn{padding:8px 16px;border:1px solid rgba(199,167,94,.35);border-radius:14px;background:rgba(199,167,94,.08);color:var(--muted);font-size:13px;cursor:pointer;transition:all .25s;white-space:nowrap}
.sug-btn:hover{background:rgba(199,167,94,.18);color:var(--gold);border-color:var(--gold);transform:translateY(-1px)}

.thinking{position:absolute;left:37px;top:0;bottom:0;width:3px;background:linear-gradient(to bottom,transparent 0%,rgba(199,167,94,.6) 30%,rgba(199,167,94,.95) 50%,rgba(199,167,94,.6) 70%,transparent 100%);opacity:0;transition:opacity .3s}
.thinking.active{opacity:1;animation:pulse 2.2s ease-in-out infinite}

footer{border-top:1px solid var(--line);padding:18px 20px;display:flex;gap:14px;align-items:flex-end}
#input{flex:1;padding:14px 18px;border:1px solid var(--line);border-radius:14px;background:#12121A;color:var(--text);font:15px Inter,sans-serif;resize:none;max-height:140px;line-height:1.5}
#input:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px rgba(199,167,94,.12)}
#input::placeholder{color:rgba(179,179,185,.5);font-style:italic}

#send{padding:14px 22px;border:none;border-radius:50%;background:var(--gold);color:var(--bg-0);font-size:20px;font-weight:700;cursor:pointer;transition:all .2s;min-width:52px;min-height:52px;display:flex;align-items:center;justify-content:center}
#send:hover{background:var(--gold-2);transform:scale(1.05)}
#send:disabled{opacity:.35;cursor:not-allowed;transform:none}

audio{display:none}

@media(max-width:768px){
  .user-msg{padding-right:10px}
  .ai-msg{padding-left:10px}
  .ai-msg .content{max-width:100%}
  .thinking{left:7px}
}
</style>
</head>
<body>
<div id="bg"></div>
<div class="thinking" id="thinking"></div>

<div class="container">
<div class="title">ZANTARA // LIVING INTERFACE</div>

<div id="chat">
<div class="msg ai-msg">
<div class="content" id="welcomeMsg">
<p><strong>Ciao <span id="userName">Zero</span>.</strong></p>
<p>Benvenuto nell'interfaccia viva di ZANTARA. Qui parliamo di visti, business e investimenti in Indonesia.</p>
<p>Chiedimi qualsiasi cosa su <strong>D12</strong>, <strong>E33G</strong>, <strong>PT PMA</strong>, o proprietà immobiliari.</p>
<div class="suggestions">
<span class="sug-btn" onclick="document.getElementById('input').value='Costo visa D12?';handleSend()">Costo visa D12?</span>
<span class="sug-btn" onclick="document.getElementById('input').value='Come aprire una PT PMA?';handleSend()">Come aprire una PT PMA?</span>
<span class="sug-btn" onclick="document.getElementById('input').value='Posso comprare casa come straniero?';handleSend()">Posso comprare casa come straniero?</span>
</div>
</div>
</div>
</div>

<footer>
<textarea id="input" placeholder="Scrivi con calma, la mente ascolta..." rows="1"></textarea>
<button id="send">∞</button>
</footer>
</div>

<audio id="breath" src="assets/infinity_breath.mp3" preload="auto"></audio>

<script>
// Auth guard
if(!ZANTARA_API.isLoggedIn()){window.location.href='login.html'}
const user=ZANTARA_API.getUser();

// Set welcome name
if(user&&user.name){
  document.getElementById('userName').textContent=user.name;
}

const chatDiv=document.getElementById('chat');
const input=document.getElementById('input');
const sendBtn=document.getElementById('send');
const thinking=document.getElementById('thinking');
const breath=document.getElementById('breath');

// Markdown config
if(typeof marked!=='undefined'){
  marked.setOptions({breaks:true,gfm:true});
}

function renderMarkdown(text){
  if(typeof marked!=='undefined'){
    return marked.parse(text);
  }
  return text.replace(/\n/g,'<br>');
}

function appendUser(text){
  const msg=document.createElement('div');
  msg.className='msg user-msg';
  const bubble=document.createElement('div');
  bubble.className='bubble';
  bubble.textContent=text;
  msg.appendChild(bubble);
  chatDiv.appendChild(msg);
  chatDiv.scrollTop=chatDiv.scrollHeight;
}

function appendAI(text,suggestions=[]){
  const msg=document.createElement('div');
  msg.className='msg ai-msg';

  const content=document.createElement('div');
  content.className='content';
  content.innerHTML=renderMarkdown(text);

  // Add suggestions if provided
  if(suggestions&&suggestions.length>0){
    const sugDiv=document.createElement('div');
    sugDiv.className='suggestions';
    suggestions.forEach(s=>{
      const btn=document.createElement('span');
      btn.className='sug-btn';
      btn.textContent=s;
      btn.onclick=()=>{input.value=s;handleSend()};
      sugDiv.appendChild(btn);
    });
    content.appendChild(sugDiv);
  }

  msg.appendChild(content);
  chatDiv.appendChild(msg);
  chatDiv.scrollTop=chatDiv.scrollHeight;
  return content;
}

function setThinking(active){
  thinking.classList.toggle('active',active);
  if(active){
    try{breath.volume=.18;breath.play()}catch(e){}
  }else{
    try{breath.pause();breath.currentTime=0}catch(e){}
  }
}

async function handleSend(){
  const t=input.value.trim();
  if(!t)return;

  appendUser(t);
  input.value='';
  sendBtn.disabled=true;
  setThinking(true);

  const userEmail=localStorage.getItem('zantara-email')||user?.email||'';

  // Try SSE streaming first
  if(window.ZANTARA_SSE&&window.ZANTARA_SSE.stream){
    const contentDiv=appendAI('Pensando...');

    window.ZANTARA_SSE.on('start',()=>{
      contentDiv.innerHTML='';
    });

    window.ZANTARA_SSE.on('delta',({message:chunk})=>{
      contentDiv.innerHTML=renderMarkdown(chunk);
      chatDiv.scrollTop=chatDiv.scrollHeight;
    });

    window.ZANTARA_SSE.on('complete',({message:fullMessage,sources})=>{
      contentDiv.innerHTML=renderMarkdown(fullMessage);

      // Add suggestions based on context
      const suggestions=generateSuggestions(t,fullMessage);
      if(suggestions.length>0){
        const sugDiv=document.createElement('div');
        sugDiv.className='suggestions';
        suggestions.forEach(s=>{
          const btn=document.createElement('span');
          btn.className='sug-btn';
          btn.textContent=s;
          btn.onclick=()=>{input.value=s;handleSend()};
          sugDiv.appendChild(btn);
        });
        contentDiv.appendChild(sugDiv);
      }

      setThinking(false);
      sendBtn.disabled=false;
      chatDiv.scrollTop=chatDiv.scrollHeight;
    });

    window.ZANTARA_SSE.on('error',(error)=>{
      console.error('SSE Error:',error);
      contentDiv.innerHTML='<em style="color:#ef4444">Impossibile rispondere. Riprova tra un momento.</em>';
      setThinking(false);
      sendBtn.disabled=false;
    });

    await window.ZANTARA_SSE.stream(t,userEmail);

  }else{
    // Fallback to regular API
    try{
      const response=await ZANTARA_API.chat(t,userEmail);
      if(response.success){
        const suggestions=generateSuggestions(t,response.response);
        appendAI(response.response,suggestions);
      }else{
        appendAI('Impossibile rispondere. Riprova tra un momento.');
      }
    }catch(error){
      console.error('API Error:',error);
      appendAI('Errore di connessione. Verifica la tua connessione.');
    }
    setThinking(false);
    sendBtn.disabled=false;
  }
}

function generateSuggestions(query,response){
  const q=query.toLowerCase();
  const r=response.toLowerCase();

  // Context-aware suggestions
  if(q.includes('d12')||q.includes('costo')||q.includes('visa')){
    return [
      'Quanto dura la procedura?',
      'Quali altri visti esistono?',
      'Mostrami la checklist ufficiale'
    ];
  }
  if(q.includes('e33g')||q.includes('second home')){
    return [
      'Differenze tra D12 e E33G?',
      'Requisiti per E33G?',
      'Posso lavorare con E33G?'
    ];
  }
  if(q.includes('pt pma')||q.includes('company')||q.includes('business')){
    return [
      'Quanto costa aprire una PT PMA?',
      'Quali documenti servono?',
      'Tempi di approvazione?'
    ];
  }
  if(q.includes('property')||q.includes('proprietà')||q.includes('immobile')){
    return [
      'Posso comprare come straniero?',
      'Differenza Hak Pakai e Leasehold?',
      'Tasse sulla proprietà?'
    ];
  }

  // Default suggestions
  return [
    'Parlami dei visti disponibili',
    'Come aprire una società?',
    'Investimenti immobiliari in Indonesia'
  ];
}

sendBtn.addEventListener('click',handleSend);
input.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){
    e.preventDefault();
    handleSend();
  }
});

// Auto-resize textarea
input.addEventListener('input',function(){
  this.style.height='auto';
  this.style.height=Math.min(this.scrollHeight,140)+'px';
});
</script>
</body>
</html>
