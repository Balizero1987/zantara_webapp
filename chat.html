<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ZANTARA - Chat (RAG Connected)</title>
    <meta name="description" content="Zantara: Your AI companion for collaborative intelligence - RAG Backend Connected">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000000;
            color: #ffffff;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: env(safe-area-inset-bottom, 20px);
            background: radial-gradient(
                ellipse at 50% 30%,
                rgba(124, 58, 237, 0.08) 0%,
                transparent 50%
            );
            pointer-events: none;
            z-index: 0;
        }

        /* Connection Status Indicator */
        .connection-status {
            position: fixed;
            top: 16px;
            right: 16px;
            padding: 10px 18px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.22);
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.35);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.15), 0 10px 30px rgba(16, 185, 129, 0.25);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 72px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px) saturate(150%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-small {
            width: 40px;
            height: 40px;
            filter: drop-shadow(0 4px 12px rgba(168, 85, 247, 0.4));
        }

        .brand-name-small {
            font-family: 'Geist', sans-serif;
            font-size: 24px;
            font-weight: 900;
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, #ffffff 0%, #a855f7 50%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(168, 85, 247, 0.3);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            border: 2px solid rgba(168, 85, 247, 0.3);
        }

        /* Chat Container */
        .chat-container {
            position: relative;
            z-index: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 72px;
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px));
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .messages-area::-webkit-scrollbar {
            width: 8px;
        }

        .messages-area::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .messages-area::-webkit-scrollbar-thumb {
            background: rgba(168, 85, 247, 0.3);
            border-radius: 4px;
        }

        .messages-area::-webkit-scrollbar-thumb:hover {
            background: rgba(168, 85, 247, 0.5);
        }

        /* Message Bubbles */
        .message {
            display: flex;
            gap: 12px;
            max-width: 80%;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            border: 2px solid rgba(168, 85, 247, 0.3);
        }

        .message.assistant .message-avatar {
            background: rgba(168, 85, 247, 0.2);
            border: 2px solid rgba(168, 85, 247, 0.3);
        }

        .message-content {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 12px 16px;
            backdrop-filter: blur(20px) saturate(150%);
        }

        .message.user .message-content {
            background: rgba(168, 85, 247, 0.2);
            border-color: rgba(168, 85, 247, 0.3);
        }

        .message-text {
            font-size: 15px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.95);
            white-space: pre-wrap;
        }

        .message-time {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 6px;
        }

        /* Error message */
        .message.error .message-content {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(168, 85, 247, 0.6);
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Input Area */
        .input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 24px calc(24px + env(safe-area-inset-bottom, 0px));
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px) saturate(150%);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .input-container {
            position: relative;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            min-height: 52px;
            max-height: 150px;
            padding: 14px 48px 14px 16px;
            border-radius: 26px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            line-height: 1.5;
        }

        .chat-input:focus {
            border-color: #a855f7;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .input-actions {
            position: absolute;
            right: 8px;
            bottom: 8px;
            display: flex;
            gap: 4px;
        }

        .input-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .input-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .send-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(168, 85, 247, 0.4);
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(168, 85, 247, 0.6);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Suggestions */
        .suggestions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .suggestions::-webkit-scrollbar {
            height: 4px;
        }

        .suggestions::-webkit-scrollbar-track {
            background: transparent;
        }

        .suggestions::-webkit-scrollbar-thumb {
            background: rgba(168, 85, 247, 0.3);
            border-radius: 2px;
        }

        .suggestion-chip {
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .suggestion-chip:hover {
            background: rgba(168, 85, 247, 0.2);
            border-color: rgba(168, 85, 247, 0.3);
        }

        /* Welcome Screen */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
            gap: 32px;
        }

        .welcome-logo {
            width: 180px;
            height: 180px;
            filter: drop-shadow(0 20px 50px rgba(168, 85, 247, 0.5));
        }

        .welcome-title {
            font-family: 'Geist', sans-serif;
            font-size: 42px;
            font-weight: 700;
            letter-spacing: 0.02em;
            line-height: 1.2;
        }

        .welcome-title .greeting {
            color: rgba(255, 255, 255, 0.6);
            font-size: 32px;
            font-weight: 400;
            display: block;
            margin-bottom: 8px;
        }

        .welcome-title .username {
            background: linear-gradient(135deg, #ffffff 0%, #a855f7 50%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
            letter-spacing: 0.05em;
        }


        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
            }
            .brand-name-small {
                font-size: 20px;
            }
            .messages-area {
                padding: 16px;
                padding-bottom: calc(100px + env(safe-area-inset-bottom, 0px));
            }
            .message {
                max-width: 90%;
            }
            .input-area {
                padding: 12px 16px calc(16px + env(safe-area-inset-bottom, 0px));
            }
            .welcome-logo {
                width: 140px;
                height: 140px;
            }
            .welcome-title {
                font-size: 32px;
            }
            .welcome-title .greeting {
                font-size: 24px;
            }
        }

        ::selection {
            background: rgba(168, 85, 247, 0.3);
            color: #ffffff;
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div class="connection-status disconnected" id="connectionStatus">
        <div class="connection-dot"></div>
        <span id="connectionText">Connecting...</span>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <img src="zantara_logo_transparent.png" alt="Zantara" class="logo-small" onerror="this.style.display='none'">
            <h1 class="brand-name-small">ZANTARA</h1>
        </div>
        <div class="header-right">
            <button class="header-btn" id="newChatBtn" title="New Chat">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                </svg>
            </button>
            <button class="header-btn" title="Settings">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                </svg>
            </button>
            <button class="header-btn" title="Logout" onclick="handleLogout()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V4a1 1 0 00-1-1H3zm11 4.414l-4.293 4.293a1 1 0 01-1.414 0L4 7.414 5.414 6l3.293 3.293L13.586 5 15 6.414z" clip-rule="evenodd"/>
                    <path d="M11 0h1v4h-1V0zM17.778 2.222l.707.707-2.828 2.828-.707-.707 2.828-2.828z"/>
                </svg>
            </button>
            <div class="user-avatar" id="userAvatar" title="Click to view profile" style="cursor: pointer;">A</div>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
        <!-- Welcome Screen (shown when no messages) -->
        <div class="welcome-screen" id="welcomeScreen">
            <img src="zantara_logo_transparent.png" alt="Zantara" class="welcome-logo" onerror="this.textContent='ðŸŒ¸'">

            <h2 class="welcome-title">
                <span class="greeting">WELCOME</span>
                <span class="username" id="userName">AMANDA</span>
            </h2>
        </div>

        <!-- Messages Area (hidden initially) -->
        <div class="messages-area" id="messagesArea" style="display: none;">
            <!-- Messages will be added here dynamically -->
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="suggestions" id="suggestions">
                <div class="suggestion-chip">Help with PT setup</div>
                <div class="suggestion-chip">Team information</div>
                <div class="suggestion-chip">Generate quote</div>
                <div class="suggestion-chip">Contact details</div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <textarea
                        id="chatInput"
                        class="chat-input"
                        placeholder="Message ZANTARA..."
                        rows="1"
                    ></textarea>
                    <div class="input-actions">
                        <button class="input-btn" title="Attach file">
                            <svg width="18" height="18" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <button class="send-btn" id="sendBtn" disabled>
                    <svg width="24" height="24" fill="white" viewBox="0 0 20 20">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            // Backend URL - PRODUCTION RAG BACKEND
            BACKEND_URL: 'https://zantara-rag-backend-1064094238013.europe-west1.run.app',
            // Use new /chat endpoint
            USE_BALI_ZERO: false,
            MODEL: 'haiku', // 'haiku' or 'sonnet'
            USER_NAME: 'AMANDA' // Customize based on logged user
        };

        // Health check configuration
        const HEALTH = {
            timeoutMs: 35000,        // 35s timeout (allow cold start from GCS)
            maxRetries: 2,           // number of retries on failure
            retryBaseDelay: 2000,    // initial backoff in ms
            pollIntervalMs: 60000    // periodic recheck when offline (60s)
        };

        // Global state
        let conversationHistory = [];
        let isTyping = false;
        let backendAvailable = false;
        let healthMonitorId = null;
        let recognizedProfile = null;

        // DOM Elements
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesArea = document.getElementById('messagesArea');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const suggestions = document.getElementById('suggestions');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        const newChatBtn = document.getElementById('newChatBtn');
        let currentUserEmail = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const userEmail = localStorage.getItem('zantara-user-email');
            const userName = localStorage.getItem('zantara-user-name');

            if (!userEmail) {
                // Redirect to login if not authenticated
                window.location.href = 'login.html';
                return;
            }

            // Set user name from localStorage
            const displayName = userName || userEmail.split('@')[0].toUpperCase();
            document.getElementById('userName').textContent = displayName;
            document.getElementById('userAvatar').textContent = displayName.charAt(0);
            currentUserEmail = userEmail;

            checkBackendHealth();
            startHealthMonitor();
            setupEventListeners();
        });

        // Simple delay helper
        function delay(ms) { return new Promise(res => setTimeout(res, ms)); }

        // Check backend health (with retries and exponential backoff)
        async function checkBackendHealth(attempt = 0) {
            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}/health`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(HEALTH.timeoutMs)
                });

                if (!response.ok) throw new Error(`Health check failed: ${response.status}`);

                const data = await response.json();
                backendAvailable = true;
                updateConnectionStatus(true, `Connected (${data.version || 'v1.0'})`);
                console.log('âœ… Backend connected:', data);
                // Try to fetch collaborator profile if we have an email
                if (currentUserEmail) {
                    try {
                        const prof = await fetch(`${CONFIG.BACKEND_URL}/admin/collaborators/${encodeURIComponent(currentUserEmail)}`);
                        if (prof.ok) {
                            const profData = await prof.json();
                            recognizedProfile = profData;
                            if (profData.recognized && profData.profile) {
                                const level = profData.profile.sub_rosa_level;
                                const name = profData.profile.ambaradam_name || profData.profile.name;
                                updateConnectionStatus(true, `Connected (${data.version || 'v1.0'}) â€¢ ${name} L${level}`);
                            }
                        }
                    } catch(_e) { /* ignore */ }
                }
                return true;
            } catch (error) {
                if (attempt < HEALTH.maxRetries) {
                    const backoff = HEALTH.retryBaseDelay * Math.pow(2, attempt);
                    console.warn(`âš ï¸ Health check failed (attempt ${attempt + 1}). Retrying in ${backoff}ms...`, error.message);
                    await delay(backoff);
                    return checkBackendHealth(attempt + 1);
                }
                backendAvailable = false;
                updateConnectionStatus(false, 'Offline - Using fallback');
                console.warn('âš ï¸ Backend unavailable (after retries):', error.message);
                return false;
            }
        }

        // Periodic health monitor: when offline, recheck every pollIntervalMs
        function startHealthMonitor() {
            if (healthMonitorId) return; // avoid duplicates
            healthMonitorId = setInterval(async () => {
                if (!backendAvailable) {
                    await checkBackendHealth();
                } else if (currentUserEmail && (!recognizedProfile || !recognizedProfile.recognized)) {
                    // Periodically re-assert identity if backend is up but profile not recognized yet
                    try {
                        const prof = await fetch(`${CONFIG.BACKEND_URL}/admin/collaborators/${encodeURIComponent(currentUserEmail)}`);
                        if (prof.ok) {
                            const profData = await prof.json();
                            recognizedProfile = profData;
                            if (profData.recognized && profData.profile) {
                                const level = profData.profile.sub_rosa_level;
                                const name = profData.profile.ambaradam_name || profData.profile.name;
                                updateConnectionStatus(true, `Connected (v2.0.0-cloud) â€¢ ${name} L${level}`);
                            }
                        }
                    } catch(_e) { /* ignore */ }
                }
            }, HEALTH.pollIntervalMs);
        }

        // Update connection status indicator
        function updateConnectionStatus(connected, text) {
            connectionStatus.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
            connectionText.textContent = text;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auto-resize textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
                sendBtn.disabled = !this.value.trim();
            });

            // Send on Enter
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage(chatInput.value);
                }
            });

            // Send button click
            sendBtn.addEventListener('click', () => sendMessage(chatInput.value));

            // New chat button
            newChatBtn.addEventListener('click', newChat);

            // Suggestion chips
            document.querySelectorAll('.suggestion-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const prompt = chip.textContent.trim();
                    chatInput.value = prompt;
                    sendBtn.disabled = false;
                    sendMessage(prompt);
                });
            });
        }

        // Send message
        async function sendMessage(text) {
            if (!text.trim() || isTyping) return;

            // Hide welcome screen, show messages
            welcomeScreen.style.display = 'none';
            messagesArea.style.display = 'flex';
            suggestions.style.display = 'none';

            // Add user message
            addMessage(text, 'user');

            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                content: text
            });

            // Clear input
            chatInput.value = '';
            chatInput.style.height = 'auto';
            sendBtn.disabled = true;

            // Show typing indicator
            isTyping = true;
            const typingMsg = addTypingIndicator();

            // Call API
            try {
                const response = await getAIResponse(text);
                typingMsg.remove();
                addMessage(response, 'assistant');

                // Add to conversation history
                conversationHistory.push({
                    role: 'assistant',
                    content: response
                });
            } catch (error) {
                typingMsg.remove();
                addMessage(error.message, 'assistant', true);
                console.error('âŒ Error getting AI response:', error);
            } finally {
                isTyping = false;
            }
        }

        // Get AI response from backend
        async function getAIResponse(message) {
            // If backend is available, use RAG backend
            if (backendAvailable) {
                try {
                    // Use /bali-zero/chat endpoint (RAG + LLM)
                    const endpoint = `${CONFIG.BACKEND_URL}/bali-zero/chat`;

                    // If user typed an email, capture and persist it for identity
                    try {
                        const emailMatch = message.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[A-Za-z]{2,}/);
                        if (emailMatch && emailMatch[0]) {
                            currentUserEmail = emailMatch[0].toLowerCase();
                            // Persist email and derive display name
                            try {
                                localStorage.setItem('zantara-user-email', currentUserEmail);
                                const derivedName = currentUserEmail.split('@')[0].toUpperCase();
                                localStorage.setItem('zantara-user-name', derivedName);
                                // Reflect immediately in UI
                                document.getElementById('userName').textContent = derivedName;
                                document.getElementById('userAvatar').textContent = derivedName.charAt(0);
                            } catch(_) {}
                            console.log('ðŸ“§ Captured user email from chat:', currentUserEmail);
                            // Reset recognition and try to fetch profile
                            recognizedProfile = null;
                            if (backendAvailable) {
                                try {
                                    const prof = await fetch(`${CONFIG.BACKEND_URL}/admin/collaborators/${encodeURIComponent(currentUserEmail)}`);
                                    if (prof.ok) {
                                        const profData = await prof.json();
                                        recognizedProfile = profData;
                                        if (profData.recognized && profData.profile) {
                                            const level = profData.profile.sub_rosa_level;
                                            const name = profData.profile.ambaradam_name || profData.profile.name;
                                            updateConnectionStatus(true, `Connected (v2.0.0-cloud) â€¢ ${name} L${level}`);
                                        }
                                    }
                                } catch(_) { /* ignore */ }
                            }
                        }
                    } catch(_) { /* ignore */ }

                    // Convert conversation history to backend format
                    const formattedHistory = conversationHistory.map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));

                    const requestBody = {
                        query: message,
                        conversation_history: formattedHistory,
                        user_role: "member",
                        user_email: currentUserEmail || null
                    };

                    // If the user asks identity and we already recognized the profile, reply locally for immediate personalization
                    const m = message.trim().toLowerCase();
                    if ((m === 'chi sono?' || m === 'chi sono' || m === 'who am i?' || m === 'who am i') && recognizedProfile && recognizedProfile.recognized && recognizedProfile.profile) {
                        const p = recognizedProfile.profile;
                        const isIt = (p.language || 'en').toLowerCase().startsWith('it');
                        const name = p.ambaradam_name || p.name || 'Collaboratore';
                        const level = typeof p.sub_rosa_level === 'number' ? p.sub_rosa_level : 0;
                        return isIt
                          ? `Ciao ${name}, sei riconosciuto come collaboratore Bali Zero (Sub Rosa L${level}).`
                          : `Hello ${name}, you are recognized as a Bali Zero collaborator (Sub Rosa L${level}).`;
                    }

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody),
                        signal: AbortSignal.timeout(45000) // 45s timeout (allow cold start)
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();

                    // RAG backend returns: { success: true, response: "...", model_used: "...", sources: [...] }
                    if (data.success && data.response) {
                        console.log(`âœ… Response from ${data.model_used || 'unknown model'}`, data.sources ? `with ${data.sources.length} sources` : '');
                        // Client-side personalization prefix when recognized
                        try {
                            if (recognizedProfile && recognizedProfile.recognized && recognizedProfile.profile) {
                                const p = recognizedProfile.profile;
                                const isIt = (p.language || 'en').toLowerCase().startsWith('it');
                                const name = p.ambaradam_name || p.name;
                                const lower = data.response.trim().toLowerCase();
                                const hasGreeting = /^(ciao|salve|hello|hi)/.test(lower);
                                const hasName = name && data.response.slice(0, 100).toLowerCase().includes(name.toLowerCase());
                                if (name && (!hasGreeting || !hasName)) {
                                    const prefix = isIt ? `Ciao ${name}, ` : `Hello ${name}, `;
                                    return prefix + data.response;
                                }
                            }
                        } catch(_) { /* ignore */ }
                        return data.response;
                    } else {
                        throw new Error('Invalid response format from API');
                    }
                } catch (error) {
                    console.error('Backend API call failed:', error);
                    backendAvailable = false;
                    updateConnectionStatus(false, 'Connection lost');
                    throw new Error('Mi dispiace, sto avendo difficoltÃ  a connettermi al server. Riprova tra poco.');
                }
            } else {
                // Fallback to simple responses
                return getFallbackResponse(message);
            }
        }

        // Fallback response when backend is unavailable
        function getFallbackResponse(input) {
            const responses = {
                'team': 'We have 23 talented team members across 7 departments at Bali Zero. Would you like to know more about a specific department?\n\n(Note: RAG backend is offline, this is a fallback response)',
                'quote': 'I can help you generate a quote. Our PT PMA setup service starts at $2,500. What specific services are you interested in?\n\n(Note: RAG backend is offline)',
                'contact': 'You can reach Bali Zero at info@balizero.com or visit our office in Seminyak, Bali. We\'re open Monday to Friday, 9 AM - 6 PM.\n\n(Note: RAG backend is offline)',
                'service': 'Bali Zero offers comprehensive business setup services including PT PMA formation, visa assistance, tax consulting, and accounting services.\n\n(Note: RAG backend is offline)',
                'default': 'Thank you for your message! I\'m ZANTARA, your AI assistant.\n\nNote: The RAG backend is currently offline. I\'m using fallback responses. Please check the connection status or try again later for AI-powered responses with knowledge base search.'
            };

            const lower = input.toLowerCase();
            for (let key in responses) {
                if (lower.includes(key)) return responses[key];
            }
            return responses.default;
        }

        // Sanitize assistant output for public users (hide sensitive terminology)
        function sanitizePublicText(text) {
            try {
                const replacements = [
                    [/\besoteric\b/gi, 'advanced'],
                    [/\besoterico\b/gi, 'avanzato'],
                    [/\besoteriche\b/gi, 'avanzate'],
                    [/\bmysticism\b/gi, 'tradition'],
                    [/\bsacro\b/gi, 'tradizionale'],
                    [/\bsacred\b/gi, 'traditional'],
                    [/\binitiatic\b/gi, 'advanced'],
                    [/\biniziatico\b/gi, 'avanzato'],
                    [/\boccult\b/gi, 'classical'],
                    [/\bocculto\b/gi, 'classico'],
                    [/sub rosa/gi, 'private']
                ];
                let out = text;
                for (const [re, repl] of replacements) out = out.replace(re, repl);
                return out;
            } catch(_) { return text; }
        }

        // Add message to chat
        function addMessage(text, type, isError = false) {
            let displayText = text;
            try {
                const level = recognizedProfile && recognizedProfile.profile ? (recognizedProfile.profile.sub_rosa_level || 0) : 0;
                const recognized = recognizedProfile ? !!recognizedProfile.recognized : false;
                if (type === 'assistant' && (!recognized || level < 2)) {
                    displayText = sanitizePublicText(text);
                }
            } catch(_) { /* ignore */ }
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}${isError ? ' error' : ''}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'user' ? CONFIG.USER_NAME.charAt(0) : 'ðŸŒ¸';

            const content = document.createElement('div');
            content.className = 'message-content';

            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.textContent = displayText;

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });

            content.appendChild(messageText);
            content.appendChild(time);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);

            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;

            return messageDiv;
        }

        // Add typing indicator
        function addTypingIndicator() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'ðŸŒ¸';

            const content = document.createElement('div');
            content.className = 'message-content';

            const typing = document.createElement('div');
            typing.className = 'typing-indicator';
            typing.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';

            content.appendChild(typing);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);

            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;

            return messageDiv;
        }

        // New chat
        function newChat() {
            if (confirm('Start a new conversation? Current chat will be cleared.')) {
                messagesArea.innerHTML = '';
                messagesArea.style.display = 'none';
                welcomeScreen.style.display = 'flex';
                suggestions.style.display = 'flex';
                conversationHistory = [];
                console.log('ðŸ”„ New chat started');
            }
        }

        // Retry connection every 30 seconds if offline
        setInterval(() => {
            if (!backendAvailable) {
                console.log('ðŸ”„ Retrying backend connection...');
                checkBackendHealth();
            }
        }, 30000);

        // Logout handler
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('zantara-user-email');
                localStorage.removeItem('zantara-user-name');
                localStorage.removeItem('zantara-theme');
                window.location.href = 'login.html';
            }
        }

        // User avatar click - show profile menu
        document.addEventListener('DOMContentLoaded', function() {
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.addEventListener('click', function() {
                    const email = localStorage.getItem('zantara-user-email');
                    const name = localStorage.getItem('zantara-user-name');
                    alert(`ðŸ‘¤ User Profile\n\nName: ${name}\nEmail: ${email}\n\nClick the logout button to sign out.`);
                });
            }
        });
    </script>
</body>
</html>
