<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#10b981">
  <title>ZANTARA - Official</title>
  
  <!-- PWA Support -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  
  <!-- Core Services (load first) -->
  <script src="js/api-config-unified.js?v=2025102106"></script>
  <script src="js/send-message-updated.js?v=2025102106"></script>
  <script src="js/team-login.js?v=2025102106"></script>
  <link rel="stylesheet" href="styles/design-tokens.css">
  <link rel="stylesheet" href="styles/chat.css">
  <link rel="stylesheet" href="styles/message-formatter.css">
  <link rel="stylesheet" href="styles/indonesian-badges.css">
  <link rel="stylesheet" href="styles/chat-enhancements.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/github-dark.min.css">
  <script src="js/message-formatter.js"></script>
  <script src="js/user-badges.js"></script>
  <script src="js/chat-enhancements.js"></script>
  <script src="js/zero-intelligent-analytics.js"></script>
  <script src="js/zantara-thinking-indicator.js?v=2025102104"></script>

  <!-- üîí AUTH GUARD - Redirect to login if not authenticated -->
  <script>
    // IMPORTANT: This runs BEFORE page loads to prevent unauthorized access
    (function() {
      // Check authentication status
      const token = localStorage.getItem('zantara-auth-token');
      const user = localStorage.getItem('zantara-user');

      // Legacy public login support (for backward compatibility)
      const legacyEmail = localStorage.getItem('zantara-user-email');

      // If neither team auth nor legacy auth exists, redirect to login
      if (!token && !user && !legacyEmail) {
        // Store attempted URL for redirect after login
        sessionStorage.setItem('zantara-redirect-after-login', window.location.href);

        // Redirect to login page
        window.location.replace('login.html');
      }
    })();
  </script>
</head>
<body>
  <!-- APP -->
  <div class="app">
    <header class="header">
      <div class="header-left">
        <img src="assets/logoscon.png" class="logo" alt="ZANTARA">
        <button class="sidebar-toggle" id="leftToggle">‚ò∞</button>
      </div>

      <div class="header-center">
        <!-- Logo is enough, no text needed -->
      </div>

      <div class="header-right">
        <button class="user-btn" id="userBtn" style="display:none;">
          <span id="userIcon">üë§</span>
          <span id="userName"></span>
        </button>
        <button class="login-btn" id="loginBtn" onclick="window.location.href='login.html'">
          <span>üîë</span>
          <span>Login</span>
        </button>
        <button class="sidebar-toggle" id="rightToggle">‚ò∞</button>
        <button class="theme-toggle">
          <span>üåô</span>
          <span>Night</span>
        </button>
      </div>
    </header>

    <!-- USER DROPDOWN MENU -->
    <div class="user-dropdown" id="userDropdown">
      <div class="user-dropdown-item" id="profileBtn">
        <span>üë§</span>
        <span>Profile</span>
      </div>
      <div class="user-dropdown-item" id="uploadPhotoBtn">
        <span>üì∏</span>
        <span>Upload Photo</span>
      </div>
      <div class="user-dropdown-divider"></div>
      <div class="user-dropdown-item" id="logoutBtn">
        <span>üö™</span>
        <span>Logout</span>
      </div>
    </div>

    <!-- IMAGE GENERATION MODAL -->
    <div class="modal" id="imageGenModal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>üé® Generate AI Image</h3>
          <button class="modal-close" onclick="document.getElementById('imageGenModal').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
          <label for="imagePrompt">Describe the image you want to generate:</label>
          <textarea id="imagePrompt" placeholder="e.g., Beautiful Indonesian woman in traditional kebaya, Bali temple background, sunset, photorealistic" rows="4" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #2a2a2a; color: white;"></textarea>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
            <div>
              <label for="imageStyle">Style:</label>
              <select id="imageStyle" style="width: 100%; padding: 8px; border-radius: 6px; background: #2a2a2a; color: white; border: 1px solid #444;">
                <option value="realistic">Realistic</option>
                <option value="anime">Anime</option>
                <option value="flux-schnell">Flux Schnell</option>
                <option value="artistic">Artistic</option>
              </select>
            </div>
            <div>
              <label for="imageRatio">Aspect Ratio:</label>
              <select id="imageRatio" style="width: 100%; padding: 8px; border-radius: 6px; background: #2a2a2a; color: white; border: 1px solid #444;">
                <option value="16:9">16:9 (Landscape)</option>
                <option value="1:1">1:1 (Square)</option>
                <option value="9:16">9:16 (Portrait)</option>
                <option value="4:3">4:3</option>
              </select>
            </div>
          </div>

          <div id="imageGenProgress" style="display: none; margin: 15px 0;">
            <div style="background: #444; border-radius: 8px; height: 4px; overflow: hidden;">
              <div style="background: linear-gradient(90deg, #8b5cf6, #ec4899); height: 100%; width: 0%; transition: width 0.3s;" id="progressBar"></div>
            </div>
            <p style="text-align: center; margin-top: 10px; color: #8b5cf6;">‚è≥ Generating image...</p>
          </div>

          <div id="imageGenResult" style="display: none; margin: 15px 0;">
            <img id="generatedImage" style="width: 100%; border-radius: 8px; border: 2px solid #8b5cf6;" />
          </div>
        </div>
        <div class="modal-footer">
          <button id="generateImageBtn" style="padding: 10px 20px; background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Generate Image</button>
          <button id="sendImageBtn" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: none;">Send to Chat</button>
          <button onclick="document.getElementById('imageGenModal').style.display='none'" style="padding: 10px 20px; background: #444; color: white; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- PROFILE PHOTO UPLOAD MODAL -->
    <div class="modal" id="photoUploadModal" style="display: none;">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <h3>üì∏ Upload Profile Photo</h3>
          <button class="modal-close" onclick="document.getElementById('photoUploadModal').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
          <div id="photoPreview" style="width: 200px; height: 200px; margin: 20px auto; border-radius: 50%; background: #2a2a2a; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid #8b5cf6;">
            <span style="font-size: 80px;">üë§</span>
          </div>
          <input type="file" id="photoInput" accept="image/*" style="display: none;">
          <button onclick="document.getElementById('photoInput').click()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 10px;">Choose Photo</button>
        </div>
        <div class="modal-footer">
          <button id="savePhotoBtn" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: none;">Save Photo</button>
          <button onclick="document.getElementById('photoUploadModal').style.display='none'" style="padding: 10px 20px; background: #444; color: white; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
        </div>
      </div>
    </div>

    <style>
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .modal-content {
        background: #1a1a1a;
        border-radius: 12px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(139, 92, 246, 0.3);
        border: 1px solid #444;
      }
      .modal-header {
        padding: 20px;
        border-bottom: 1px solid #444;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-header h3 {
        margin: 0;
        color: white;
      }
      .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
      }
      .modal-close:hover {
        background: #444;
      }
      .modal-body {
        padding: 20px;
        color: white;
      }
      .modal-footer {
        padding: 20px;
        border-top: 1px solid #444;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .modal-body label {
        display: block;
        margin-bottom: 8px;
        color: #aaa;
        font-weight: 500;
      }
    </style>

    <main class="main">
      <!-- LEFT: CHAT HISTORY -->
      <aside class="chat-history" id="chatHistory">
        <h3>üí¨ Chat History</h3>
        <div class="history-item">
          <div class="history-title">Immigration regulations Bali</div>
          <div class="history-time">2 hours ago</div>
        </div>
        <div class="history-item">
          <div class="history-title">KITAS renewal process 2025</div>
          <div class="history-time">Yesterday</div>
        </div>
        <div class="history-item">
          <div class="history-title">Banking requirements foreigners</div>
          <div class="history-time">2 days ago</div>
        </div>
        <div class="history-item">
          <div class="history-title">Company registration Indonesia</div>
          <div class="history-time">3 days ago</div>
        </div>
        <div class="history-item">
          <div class="history-title">Tax obligations digital nomads</div>
          <div class="history-time">1 week ago</div>
        </div>
      </aside>

      <!-- CENTER: CHAT -->
      <div class="chat-wrapper">
        <div class="messages">
          <div class="welcome">
            <img src="assets/logoscon.png" class="logo-center" alt="ZANTARA Logo">
            <h2>Welcome to Zantara</h2>
            <p class="powered-by">powered by Zero AI</p>
          </div>
        </div>

        <!-- INTEGRATIONS BAR -->
        <div class="integrations-bar">
          <!-- Google Workspace -->
          <div class="integration-group">
            <span class="integration-group-label">Google:</span>
            <img src="assets/logo-google-drive.png" class="integration-logo" alt="Drive" title="Google Drive">
            <img src="assets/logo-gmail.png" class="integration-logo" alt="Gmail" title="Gmail">
            <img src="assets/logo-google-calendar.png" class="integration-logo" alt="Calendar" title="Google Calendar">
            <img src="assets/logo-google-docs.png" class="integration-logo" alt="Docs" title="Google Docs">
            <img src="assets/logo-google-sheets.png" class="integration-logo" alt="Sheets" title="Google Sheets">
            <img src="assets/logo-google-slides.png" class="integration-logo" alt="Slides" title="Google Slides">
            <img src="assets/logo-google-maps.png" class="integration-logo" alt="Maps" title="Google Maps">
            <img src="assets/logo-google-analytics.png" class="integration-logo" alt="Analytics" title="Google Analytics">
          </div>

          <!-- Social Media -->
          <div class="integration-group">
            <span class="integration-group-label">Social:</span>
            <img src="assets/logo-whatsapp.png" class="integration-logo" alt="WhatsApp" title="WhatsApp">
            <img src="assets/logo-instagram.png" class="integration-logo" alt="Instagram" title="Instagram">
            <img src="assets/logo-facebook.png" class="integration-logo" alt="Facebook" title="Facebook">
            <img src="assets/logo-x.png" class="integration-logo" alt="X (Twitter)" title="X (Twitter)">
            <img src="assets/logo-telegram.png" class="integration-logo" alt="Telegram" title="Telegram">
          </div>

          <!-- AI Services -->
          <div class="integration-group">
            <span class="integration-group-label">AI:</span>
            <img src="assets/logo-openai.png" class="integration-logo" alt="OpenAI" title="OpenAI">
            <img src="assets/logo-claude.png" class="integration-logo" alt="Claude" title="Claude">
            <img src="assets/logo-gemini.png" class="integration-logo" alt="Gemini" title="Gemini">
            <img src="assets/logo-perplexity.png" class="integration-logo" alt="Perplexity" title="Perplexity">
            <img src="assets/logo-llama.png" class="integration-logo" alt="Llama" title="Meta Llama">
          </div>
        </div>

        <div class="input-area">
          <button class="btn" id="attachBtn" title="Attach files">üìé</button>
          <button class="btn" id="imageGenBtn" title="Generate AI Image">üé®</button>
          <input type="text" class="input" placeholder="Type a message...">
          <button class="btn" id="voiceBtn" title="Voice message">üé§</button>
          <button class="btn" id="sendBtn" title="Send message">‚û§</button>
        </div>
      </div>

      <!-- RIGHT: ARTICLES -->
      <aside class="articles" id="articlesPanel">
        <div class="articles-header">
          <h3>üì∞ Daily Intel</h3>
          <div class="date">Oct 8, 2025</div>
        </div>

        <div class="filters">
          <button class="filter active">All</button>
          <button class="filter">Immigration</button>
          <button class="filter">Business</button>
          <button class="filter">Legal</button>
          <button class="filter">Finance</button>
          <button class="filter">Property</button>
        </div>

        <div class="article">
          <div class="article-cat">Immigration</div>
          <div class="article-title">New KITAS regulations effective January 2026</div>
          <div class="article-summary">The Indonesian government announced significant changes to KITAS renewal procedures.</div>
          <div class="article-meta">
            <span class="article-time">2h ago</span>
            <span class="badge">URGENT</span>
          </div>
        </div>

        <div class="article">
          <div class="article-cat">Business</div>
          <div class="article-title">PT PMA capital requirements updated</div>
          <div class="article-summary">New minimum capital requirements for foreign-owned companies in Bali.</div>
          <div class="article-meta">
            <span class="article-time">4h ago</span>
            <span class="badge">HIGH</span>
          </div>
        </div>

        <div class="article">
          <div class="article-cat">Legal</div>
          <div class="article-title">Land ownership rules clarified for foreigners</div>
          <div class="article-summary">Supreme Court issues new guidelines on property ownership.</div>
          <div class="article-meta">
            <span class="article-time">6h ago</span>
            <span class="badge">HIGH</span>
          </div>
        </div>

        <div class="article">
          <div class="article-cat">Finance</div>
          <div class="article-title">Bank Indonesia updates forex regulations</div>
          <div class="article-summary">Changes to foreign currency transactions for expat business owners.</div>
          <div class="article-meta">
            <span class="article-time">8h ago</span>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // üîç VERSION CHECK - Shows immediately which version is loaded
    console.log('üöÄ [ZANTARA] Version: SSE-STREAMING-2025-10-21-v3-RAG-FIXED');
    console.log('üìã [ZANTARA] Expected logs: üåä [SSE Stream] Starting, üì¶ [SSE Chunk]');
    console.log('üîß [ZANTARA] SSE always uses RAG backend (scintillating-kindness...)');

    /**
     * üõ°Ô∏è LOCALSTORAGE HEALTH CHECK
     * Validates and repairs corrupted localStorage at app startup
     * Prevents "Seeker" issue when user is actually logged in
     */
    (function validateAndRepairStorage() {
      console.log('üîç [Storage Validator] Checking localStorage health...');

      let needsRepair = false;
      const issues = [];

      // 1. Check 'zantara-user' (should be valid JSON)
      const userStr = localStorage.getItem('zantara-user');
      if (userStr) {
        if (userStr === 'undefined' || userStr === 'null' || userStr === '') {
          issues.push('zantara-user contains invalid literal');
          localStorage.removeItem('zantara-user');
          needsRepair = true;
        } else {
          try {
            const user = JSON.parse(userStr);
            if (!user || !user.email || typeof user.email !== 'string') {
              issues.push('zantara-user JSON is invalid (missing email)');
              localStorage.removeItem('zantara-user');
              needsRepair = true;
            }
          } catch (e) {
            issues.push('zantara-user JSON parse failed');
            localStorage.removeItem('zantara-user');
            needsRepair = true;
          }
        }
      }

      // 2. Check 'zantara-user-email' (legacy - should be valid email or null)
      const email = localStorage.getItem('zantara-user-email');
      if (email) {
        if (email === 'undefined' || email === 'null' || email === 'guest' || email === '') {
          issues.push('zantara-user-email contains invalid value');
          localStorage.removeItem('zantara-user-email');
          needsRepair = true;
        }
      }

      // 3. Check consistency: if token exists, user must exist
      const token = localStorage.getItem('zantara-auth-token');
      const user = localStorage.getItem('zantara-user');
      if (token && !user) {
        issues.push('token exists but user data missing');
        localStorage.removeItem('zantara-auth-token');
        localStorage.removeItem('zantara-permissions');
        needsRepair = true;
      }

      // 4. Report results
      if (needsRepair) {
        console.warn('‚ö†Ô∏è [Storage Validator] Found issues:', issues);
        console.log('‚úÖ [Storage Validator] Corrupted data removed. Please login again if needed.');
      } else {
        console.log('‚úÖ [Storage Validator] localStorage is healthy');
      }
    })();

    /**
     * üìß GET USER EMAIL (Unified Storage)
     * Uses ZantaraStorage for consistent, failsafe access
     */
    function getUserEmail() {
      if (window.ZantaraStorage) {
        return window.ZantaraStorage.getUserEmail();
      }

      // Fallback to manual retrieval (shouldn't happen)
      console.warn('‚ö†Ô∏è [getUserEmail] ZantaraStorage not available, using fallback');
      try {
        const userStr = localStorage.getItem('zantara-user');
        if (userStr && userStr !== 'undefined' && userStr !== 'null') {
          const user = JSON.parse(userStr);
          if (user && user.email && user.email !== 'undefined') {
            return user.email;
          }
        }
      } catch (e) {
        console.warn('[getUserEmail] Fallback failed:', e);
      }

      const legacyEmail = localStorage.getItem('zantara-user-email');
      if (legacyEmail && legacyEmail !== 'undefined' && legacyEmail !== 'null' && legacyEmail !== 'guest' && legacyEmail !== '') {
        return legacyEmail;
      }

      return null;
    }

    // Filter functionality
    document.querySelectorAll('.filter').forEach(filter => {
      filter.addEventListener('click', () => {
        document.querySelectorAll('.filter').forEach(f => f.classList.remove('active'));
        filter.classList.add('active');
      });
    });

    // Sidebar toggles
    const leftToggle = document.getElementById('leftToggle');
    const rightToggle = document.getElementById('rightToggle');
    const chatHistory = document.getElementById('chatHistory');
    const articles = document.getElementById('articlesPanel');
    const chatWrapper = document.querySelector('.chat-wrapper');
    const main = document.querySelector('.main');

    leftToggle.addEventListener('click', () => {
      chatHistory.classList.toggle('open');
      leftToggle.textContent = chatHistory.classList.contains('open') ? '‚úï' : '‚ò∞';

      // On mobile, close other sidebar when opening this one
      if (window.innerWidth <= 968 && chatHistory.classList.contains('open')) {
        articles.classList.remove('open');
        rightToggle.textContent = '‚ò∞';
      }

      updateMainLayout();
    });

    rightToggle.addEventListener('click', () => {
      articles.classList.toggle('open');
      rightToggle.textContent = articles.classList.contains('open') ? '‚úï' : '‚ò∞';

      // On mobile, close other sidebar when opening this one
      if (window.innerWidth <= 968 && articles.classList.contains('open')) {
        chatHistory.classList.remove('open');
        leftToggle.textContent = '‚ò∞';
      }

      updateMainLayout();
    });

    function updateMainLayout() {
      const leftOpen = chatHistory.classList.contains('open');
      const rightOpen = articles.classList.contains('open');
      const isMobile = window.innerWidth <= 968;

      if (!isMobile) {
        // Desktop: Use grid layout (sidebars push content)
        main.classList.remove('left-open', 'right-open', 'both-open');

        if (leftOpen && rightOpen) {
          main.classList.add('both-open');
        } else if (leftOpen) {
          main.classList.add('left-open');
        } else if (rightOpen) {
          main.classList.add('right-open');
        }
      } else {
        // Mobile: Sidebars overlay (no grid classes needed)
        main.classList.remove('left-open', 'right-open', 'both-open');
      }
    }

    // Close sidebars when clicking on chat area (mobile only)
    chatWrapper.addEventListener('click', () => {
      if (window.innerWidth <= 968) {
        if (chatHistory.classList.contains('open')) {
          chatHistory.classList.remove('open');
          leftToggle.textContent = '‚ò∞';
        }
        if (articles.classList.contains('open')) {
          articles.classList.remove('open');
          rightToggle.textContent = '‚ò∞';
        }
        updateMainLayout();
      }
    });

    // Helper function to scroll messages to bottom
    function scrollToBottom() {
      const messagesDiv = document.querySelector('.messages');
      if (!messagesDiv) return;

      // Use requestAnimationFrame to ensure DOM is updated
      requestAnimationFrame(() => {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });

      // Double-check after a short delay for images/elements that take time to render
      setTimeout(() => {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, 100);
    }

    // Theme toggle functionality
    const themeToggle = document.querySelector('.theme-toggle');
    let isDark = true;

    themeToggle.addEventListener('click', () => {
      isDark = !isDark;

      if (isDark) {
        // Night mode - grigio scuro stile Claude
        document.body.classList.remove('day-mode');
        themeToggle.innerHTML = '<span>üåô</span><span>Night</span>';
      } else {
        // Day mode - bianco con bordi rainbow
        document.body.classList.add('day-mode');
        themeToggle.innerHTML = '<span>‚òÄÔ∏è</span><span>Day</span>';
      }
    });

    // History items - load previous chat
    document.querySelectorAll('.history-item').forEach(item => {
      item.addEventListener('click', () => {
        const title = item.querySelector('.history-title').textContent;
        const messagesDiv = document.querySelector('.messages');

        // Clear welcome message
        messagesDiv.innerHTML = `
          <div class="welcome">
            <img src="assets/logoscon.png" class="logo-center" alt="ZANTARA Logo">
            <h2>${title}</h2>
            <p class="powered-by">Chat history loaded</p>
          </div>
        `;

        // Close sidebar on mobile
        if (window.innerWidth < 968) {
          chatHistory.classList.remove('open');
          leftToggle.textContent = '‚ò∞';
          updateMainLayout();
        }
      });
    });

    // Article cards - open article
    document.querySelectorAll('.article').forEach(article => {
      article.addEventListener('click', () => {
        const title = article.querySelector('.article-title').textContent;
        const category = article.querySelector('.article-cat').textContent;

        alert(`üì∞ Opening article:\n\n${category}\n${title}\n\n(Will be connected to blog)`);
      });
    });

    // Input buttons functionality
    const inputField = document.querySelector('.input');
    const sendBtn = document.getElementById('sendBtn');
    const attachBtn = document.getElementById('attachBtn');
    const imageGenBtn = document.getElementById('imageGenBtn');
    const voiceBtn = document.getElementById('voiceBtn');

    // Debug: verify elements are found
    if (!inputField) {
      console.error('‚ùå [Init Error] Input field not found!');
    } else {
      console.log('‚úÖ [Init] Input field found and ready');
    }

    // Conversation state (FIX: track history for context)
    let conversationHistory = [];
    let lastAiUsed = null;

    // Send message with SSE streaming
    async function sendMessage() {
      console.log('üì§ [sendMessage] Function called');
      const message = inputField.value.trim();
      console.log('üìù [sendMessage] Message:', message);
      if (!message) {
        console.log('‚ö†Ô∏è [sendMessage] Empty message, returning');
        return;
      }

      const messagesDiv = document.querySelector('.messages');

      // Remove welcome if present
      const welcome = messagesDiv.querySelector('.welcome');
      if (welcome) {
        messagesDiv.innerHTML = '';
      }

      // Add user message
      const userMsg = document.createElement('div');
      userMsg.className = 'user-message';
      userMsg.textContent = message;
      messagesDiv.appendChild(userMsg);

      // Add to conversation history
      conversationHistory.push({
        role: 'user',
        content: message
      });

      // Limit history to last 20 messages for performance
      if (conversationHistory.length > 20) {
        conversationHistory = conversationHistory.slice(-20);
      }

      // Clear input
      inputField.value = '';

      // Scroll to bottom
      scrollToBottom();

      // Create empty AI message for streaming
      const aiMsg = document.createElement('div');
      aiMsg.className = 'ai-message streaming';
      aiMsg.id = 'streaming-msg';
      messagesDiv.appendChild(aiMsg);

      // üé® NEW: Use elegant thinking indicator (ChatGPT/Claude style)
      let thinkingIndicator = null;
      if (window.ZantaraThinkingIndicator) {
        thinkingIndicator = new window.ZantaraThinkingIndicator(aiMsg);
        thinkingIndicator.start();
      } else {
        // Fallback to simple text if script not loaded
        aiMsg.textContent = '‚è≥ Zantara is thinking...';
      }

      scrollToBottom();

      try {
        // Get user email using robust helper function
        const userEmail = getUserEmail();

        // DEBUG: Log streaming request
        console.log('üåä [SSE Stream] Starting for user:', userEmail || 'anonymous');

        // Use SSE streaming client
        let streamingText = '';

        // üßπ IMPORTANT: Clear all previous event listeners to prevent stacking
        // (Otherwise each new message adds MORE listeners, causing lag!)
        const events = ['start', 'delta', 'complete', 'error', 'connected', 'stop'];
        events.forEach(event => {
          const listeners = window.ZANTARA_SSE.listeners.get(event);
          if (listeners) {
            listeners.length = 0;  // Clear all listeners for this event
          }
        });

        window.ZANTARA_SSE
          .on('start', () => {
            console.log('üåä [SSE Stream] Connected');
            // Stop thinking animation and clear message
            if (thinkingIndicator) {
              thinkingIndicator.stop();
            }
            aiMsg.innerHTML = '';  // Clear thinking indicator
            aiMsg.className = 'ai-message streaming';  // Reset class
          })
          .on('delta', ({chunk, message}) => {
            // ‚ö° PERFORMANCE: Show plain text during streaming (fast!)
            // Markdown formatting will be applied only at the end
            streamingText = message;
            aiMsg.textContent = streamingText;

            // Debug: Log every chunk received (check browser console!)
            console.log('üì¶ [SSE Chunk]:', chunk);

            // Scroll only every 10 chunks to reduce lag
            if (!window._scrollCounter) window._scrollCounter = 0;
            window._scrollCounter++;
            if (window._scrollCounter % 10 === 0) {
              scrollToBottom();
            }
          })
          .on('complete', ({message: finalMessage}) => {
            console.log('‚úÖ [SSE Stream] Complete');

            // Add to conversation history
            conversationHistory.push({
              role: 'assistant',
              content: finalMessage
            });

            // Limit history
            if (conversationHistory.length > 20) {
              conversationHistory = conversationHistory.slice(-20);
            }

            // üíæ Save conversation to database (debounced)
            if (window.ConversationPersistence && userEmail) {
              window.ConversationPersistence.saveConversationDebounced(userEmail, conversationHistory);
            }

            // üé® NOW apply Markdown formatting (only once at the end)
            if (window.MessageFormatter) {
              aiMsg.innerHTML = MessageFormatter.formatStructuredMessage(finalMessage, {
                showCTA: false,
                language: MessageFormatter.detectLanguage(finalMessage, 'it')
              });
            } else {
              aiMsg.textContent = finalMessage;
            }

            aiMsg.classList.remove('streaming');
            scrollToBottom();

            // Reset scroll counter
            window._scrollCounter = 0;
          })
          .on('error', ({error}) => {
            console.error('‚ùå [SSE Stream] Error:', error);

            // Show error
            aiMsg.className = 'error-message';
            aiMsg.textContent = '‚ùå Error: ' + error;
            scrollToBottom();
          });

        // Start streaming with conversation history for context
        await window.ZANTARA_SSE.stream(message, userEmail, conversationHistory);

      } catch (error) {
        console.error('AI chat error:', error);

        // Remove streaming message
        const streaming = document.getElementById('streaming-msg');
        if (streaming) streaming.remove();

        // Show error message
        const errorMsg = document.createElement('div');
        errorMsg.className = 'error-message';
        errorMsg.textContent = '‚ùå Error: ' + (error.message || 'Failed to get response from Zantara AI');
        messagesDiv.appendChild(errorMsg);
        scrollToBottom();
      }
    }

    // Send on button click
    sendBtn.addEventListener('click', sendMessageUpdated);

    // Send on Enter key (ULTRA-ROBUST implementation)
    // Using capture phase to intercept before any other handlers
    inputField.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // Prevent default behavior
        e.stopPropagation(); // Stop event bubbling
        e.stopImmediatePropagation(); // Stop ALL other handlers
        console.log('‚úÖ [Enter Key] Detected - sending message');
        
        // Execute sendMessageUpdated in next tick to avoid conflicts
        setTimeout(() => sendMessageUpdated(), 0);
        return false;
      }
    }, true); // TRUE = capture phase (runs FIRST)

    // Fallback for keypress event (in case keydown doesn't work on some browsers)
    inputField.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        console.log('‚úÖ [Enter Key Fallback] Detected via keypress - sending message');
        setTimeout(() => sendMessageUpdated(), 0);
        return false;
      }
    }, true); // TRUE = capture phase

    // üé® IMAGE GENERATION - Imagine.art Integration
    imageGenBtn.addEventListener('click', () => {
      document.getElementById('imageGenModal').style.display = 'flex';
      document.getElementById('imageGenResult').style.display = 'none';
      document.getElementById('imageGenProgress').style.display = 'none';
      document.getElementById('sendImageBtn').style.display = 'none';
      document.getElementById('imagePrompt').value = '';
    });

    document.getElementById('generateImageBtn').addEventListener('click', async () => {
      const prompt = document.getElementById('imagePrompt').value.trim();
      if (!prompt) {
        alert('Please enter a description for the image');
        return;
      }

      const style = document.getElementById('imageStyle').value;
      const aspectRatio = document.getElementById('imageRatio').value;

      // Show progress
      document.getElementById('imageGenProgress').style.display = 'block';
      document.getElementById('imageGenResult').style.display = 'none';
      document.getElementById('generateImageBtn').disabled = true;

      // Simulate progress
      const progressBar = document.getElementById('progressBar');
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 5;
        if (progress <= 90) {
          progressBar.style.width = progress + '%';
        }
      }, 300);

      try {
        console.log('üé® Generating image with Imagine.art...', { prompt, style, aspectRatio });

        // Call Imagine.art API via backend TS
        const response = await fetch('https://ts-backend-production-568d.up.railway.app/call', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': 'zantara-internal-dev-key-2025'
          },
          body: JSON.stringify({
            key: 'ai-services.image.generate',
            params: {
              prompt: prompt,
              style: style,
              aspect_ratio: aspectRatio,
              high_res_results: 1
            }
          })
        });

        clearInterval(progressInterval);
        progressBar.style.width = '100%';

        // Get response text first for better error handling
        const responseText = await response.text();
        console.log('üîç Raw response:', responseText);

        if (!response.ok) {
          let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
          try {
            const errorData = JSON.parse(responseText);
            if (errorData.error) {
              errorMsg += ` - ${errorData.error}`;
            }
          } catch (e) {
            // If not JSON, use text
            if (responseText) {
              errorMsg += ` - ${responseText.substring(0, 200)}`;
            }
          }
          throw new Error(errorMsg);
        }

        const result = JSON.parse(responseText);
        console.log('‚úÖ Image generation response:', result);

        // Backend returns: {ok: true, data: {image_url: "..."}}
        if (result.ok && result.data && result.data.image_url) {
          // Show generated image
          document.getElementById('generatedImage').src = result.data.image_url;
          document.getElementById('imageGenResult').style.display = 'block';
          document.getElementById('imageGenProgress').style.display = 'none';
          document.getElementById('sendImageBtn').style.display = 'inline-block';

          // Store image URL for sending to chat
          window._generatedImageUrl = result.data.image_url;
          window._generatedImagePrompt = prompt;
        } else {
          console.error('‚ùå Invalid response structure:', result);
          const errDetail = result.error || result.message || 'No image URL in response';
          throw new Error(errDetail);
        }
      } catch (error) {
        console.error('‚ùå Image generation failed:', error);
        clearInterval(progressInterval);
        document.getElementById('imageGenProgress').style.display = 'none';
        
        // Show user-friendly error message
        const errorContainer = document.createElement('div');
        errorContainer.style.cssText = 'color: #ef4444; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin: 10px 0;';
        errorContainer.innerHTML = `
          <strong>‚ö†Ô∏è Image Generation Failed</strong><br>
          ${error.message}<br>
          <small>Please try again or contact support if the problem persists.</small>
        `;
        document.querySelector('#imageGenModal .modal-body').appendChild(errorContainer);
        
        // Remove error message after 5 seconds
        setTimeout(() => errorContainer.remove(), 5000);
      } finally {
        document.getElementById('generateImageBtn').disabled = false;
      }
    });

    // Send generated image to chat
    document.getElementById('sendImageBtn').addEventListener('click', () => {
      if (!window._generatedImageUrl) return;

      const messagesDiv = document.querySelector('.messages');
      const welcome = messagesDiv.querySelector('.welcome');
      if (welcome) {
        messagesDiv.innerHTML = '';
      }

      // Add image message
      const imageMsg = document.createElement('div');
      imageMsg.className = 'user-message';
      imageMsg.innerHTML = `
        <div style="margin-bottom: 8px;">üé® Generated Image: ${window._generatedImagePrompt}</div>
        <img src="${window._generatedImageUrl}" style="max-width: 100%; border-radius: 8px; border: 2px solid #8b5cf6;" />
      `;
      messagesDiv.appendChild(imageMsg);
      scrollToBottom();

      // Close modal
      document.getElementById('imageGenModal').style.display = 'none';

      // Add to conversation history
      conversationHistory.push({
        role: 'user',
        content: `[Image generated: ${window._generatedImagePrompt}]`
      });
    });

    // üì∏ PROFILE PHOTO UPLOAD
    document.getElementById('uploadPhotoBtn')?.addEventListener('click', () => {
      document.getElementById('userDropdown').classList.remove('show');
      document.getElementById('photoUploadModal').style.display = 'flex';

      // Load current photo if exists
      const savedPhoto = localStorage.getItem('zantara-user-photo');
      if (savedPhoto) {
        document.getElementById('photoPreview').innerHTML = `<img src="${savedPhoto}" style="width: 100%; height: 100%; object-fit: cover;" />`;
      }
    });

    document.getElementById('photoInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        alert('Image too large. Please choose an image under 2MB.');
        return;
      }

      // Read and preview
      const reader = new FileReader();
      reader.onload = (event) => {
        const dataUrl = event.target.result;
        document.getElementById('photoPreview').innerHTML = `<img src="${dataUrl}" style="width: 100%; height: 100%; object-fit: cover;" />`;
        document.getElementById('savePhotoBtn').style.display = 'inline-block';

        // Store temporarily
        window._pendingPhoto = dataUrl;
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('savePhotoBtn').addEventListener('click', () => {
      if (!window._pendingPhoto) return;

      // Save to localStorage
      localStorage.setItem('zantara-user-photo', window._pendingPhoto);

      // Update header avatar
      const userIcon = document.getElementById('userIcon');
      if (userIcon) {
        userIcon.innerHTML = `<img src="${window._pendingPhoto}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #8b5cf6;" />`;
      }

      alert('‚úÖ Profile photo updated!');
      document.getElementById('photoUploadModal').style.display = 'none';
      delete window._pendingPhoto;
    });

    // üìé FILE ATTACHMENT - Support documents and images
    attachBtn.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = true;
      input.accept = 'image/*,application/pdf,.doc,.docx,.txt';
      input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        const messagesDiv = document.querySelector('.messages');
        const welcome = messagesDiv.querySelector('.welcome');
        if (welcome) {
          messagesDiv.innerHTML = '';
        }

        for (const file of files) {
          // Validate size (max 5MB per file)
          if (file.size > 5 * 1024 * 1024) {
            alert(`File ${file.name} is too large (max 5MB)`);
            continue;
          }

          // Create attachment message
          const attachMsg = document.createElement('div');
          attachMsg.className = 'user-message';

          if (file.type.startsWith('image/')) {
            // Image preview
            const reader = new FileReader();
            reader.onload = (event) => {
              attachMsg.innerHTML = `
                <div style="margin-bottom: 8px;">üìé ${file.name}</div>
                <img src="${event.target.result}" style="max-width: 100%; border-radius: 8px; max-height: 400px;" />
              `;
            };
            reader.readAsDataURL(file);
          } else {
            // Document icon
            const icon = file.type.includes('pdf') ? 'üìÑ' : 'üìù';
            attachMsg.innerHTML = `
              <div style="padding: 12px; background: #2a2a2a; border-radius: 8px; border: 1px solid #444;">
                ${icon} ${file.name}
                <div style="font-size: 12px; color: #888; margin-top: 4px;">${(file.size / 1024).toFixed(1)} KB</div>
              </div>
            `;
          }

          messagesDiv.appendChild(attachMsg);
          scrollToBottom();

          // Add to conversation history
          conversationHistory.push({
            role: 'user',
            content: `[Attached file: ${file.name}]`
          });
        }
      };
      input.click();
    });
    // Check if user is logged in and initialize session
    document.addEventListener('DOMContentLoaded', () => {
      // Get user info using unified storage manager
      let userEmail = null;
      let userName = null;

      if (window.ZantaraStorage && window.ZantaraStorage.isLoggedIn()) {
        const user = window.ZantaraStorage.getUser();
        if (user) {
          userEmail = user.email;
          userName = user.name;
          console.log('‚úÖ [Chat] User loaded from storage:', userEmail);
        }
      } else {
        // Fallback to manual retrieval (legacy support)
        console.warn('‚ö†Ô∏è [Chat] ZantaraStorage not available or no session, trying fallback');
        try {
          const userStr = localStorage.getItem('zantara-user');
          if (userStr) {
            const user = JSON.parse(userStr);
            userEmail = user.email;
            userName = user.name;
          } else {
            userEmail = localStorage.getItem('zantara-user-email');
            userName = localStorage.getItem('zantara-user-name');
          }
        } catch (e) {
          userEmail = localStorage.getItem('zantara-user-email');
          userName = localStorage.getItem('zantara-user-name');
        }
      }

      const hasIntroduced = sessionStorage.getItem('zantara-introduced');

      // üíæ Load conversation history from database
      if (userEmail && window.ConversationPersistence) {
        window.ConversationPersistence.loadConversation(userEmail, 20)
          .then(messages => {
            if (messages && messages.length > 0) {
              conversationHistory = messages;
              window.ConversationPersistence.renderMessages(messages);
              console.log(`‚úÖ [Chat] Loaded ${messages.length} messages from database`);
            }
          })
          .catch(err => {
            console.error('‚ùå [Chat] Failed to load conversation history:', err);
          });
      }

      // Update UI based on login status
      const loginBtn = document.getElementById('loginBtn');
      const userBtn = document.getElementById('userBtn');
      const userNameSpan = document.getElementById('userName');

      if (userEmail) {
        // User is logged in - show user button, hide login
        loginBtn.style.display = 'none';
        userBtn.style.display = 'flex';

        // Load saved profile photo if exists
        const savedPhoto = localStorage.getItem('zantara-user-photo');
        const userIcon = document.getElementById('userIcon');
        if (savedPhoto && userIcon) {
          userIcon.innerHTML = `<img src="${savedPhoto}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #8b5cf6;" />`;
        }

        // Initialize badge system with avatar upload support
        if (window.IndonesianBadges && window.IndonesianBadges.updateUserHeader) {
          window.IndonesianBadges.updateUserHeader();
        } else {
          // Fallback if badge system not loaded
          userNameSpan.textContent = userName || userEmail.split('@')[0].toUpperCase();
        }

        // Toggle dropdown menu
        const userDropdown = document.getElementById('userDropdown');
        userBtn.onclick = (e) => {
          e.stopPropagation();
          userDropdown.classList.toggle('show');
        };

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!userBtn.contains(e.target) && !userDropdown.contains(e.target)) {
            userDropdown.classList.remove('show');
          }
        });

        // Profile button (placeholder)
        document.getElementById('profileBtn').onclick = () => {
          userDropdown.classList.remove('show');
          alert(`üë§ Profilo: ${userEmail}\n\n(Funzionalit√† in arrivo)`);
        };

        // Logout button - use unified storage manager
        document.getElementById('logoutBtn').onclick = () => {
          userDropdown.classList.remove('show');
          if (confirm('Vuoi fare logout?')) {
            // Clear conversation history on logout
            conversationHistory = [];
            lastAiUsed = null;

            // Use unified storage manager for complete cleanup
            if (window.ZantaraStorage) {
              window.ZantaraStorage.clear();
            } else if (window.teamLogin && typeof window.teamLogin.logout === 'function') {
              // Fallback to teamLogin
              window.teamLogin.logout();
            } else {
              // Final fallback: manual cleanup
              console.warn('‚ö†Ô∏è No storage manager available, manual cleanup');
              const keysToRemove = [
                'zantara-auth-token',
                'zantara-user',
                'zantara-permissions',
                'zantara-user-email',
                'zantara-user-name',
                'zantara-user-role',
                'zantara-user-department',
                'zantara-session'
              ];
              keysToRemove.forEach(key => localStorage.removeItem(key));
              sessionStorage.removeItem('zantara-introduced');
            }

            window.location.reload();
          }
        };
      } else {
        // Not logged in - show login button, hide user
        loginBtn.style.display = 'flex';
        userBtn.style.display = 'none';
      }

      // If logged in but hasn't introduced yet, send automatic introduction
      if (userEmail && !hasIntroduced) {
        // Extract first name from email
        const firstName = userEmail.split('@')[0].toLowerCase();

        // Send introduction message automatically
        setTimeout(async () => {
          const introMessage = `Ciao, sono ${firstName}`;

          try {
            const response = await window.ZANTARA_API.call('/bali-zero/chat', {
              query: introMessage,
              user_email: userEmail  // For user recognition
            }, true);

            // Mark as introduced
            sessionStorage.setItem('zantara-introduced', 'true');

            // Just log recognition, no welcome banner
            if (response?.data?.recognized) {
              console.log('‚úÖ User recognized:', firstName, '- Language:', response.data.language || 'default');
            } else {
              console.log('‚úÖ User introduced to ZANTARA:', firstName);
            }
          } catch (error) {
            console.warn('Failed to send introduction:', error);
          }
        }, 1000);
      }

      // No auto-redirect - user can use chat without login
      // Login button is always visible in header
    });
  </script>
</body>
</html>
<!-- Updated: 1729595400 - Added Imagine.art, Profile Photo, File Attachments -->
