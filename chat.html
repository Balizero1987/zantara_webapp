<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ZANTARA — The Living Intelligence</title>
<link rel="stylesheet" href="tokens.css">
<script src="js/api-contracts.js"></script>
<script src="js/zantara-api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
body{margin:0;background:linear-gradient(180deg,var(--bg-0) 0%,var(--bg-1) 100%);color:var(--text);font:14px/1.6 Inter,system-ui,sans-serif;overflow:hidden;position:relative}
#bg{position:fixed;inset:0;z-index:-1;background:radial-gradient(circle at 30% 40%,rgba(199,167,94,.07),transparent 60%),radial-gradient(circle at 70% 75%,rgba(199,167,94,.05),transparent 80%);animation:drift 12s ease-in-out infinite alternate}
body::before{content:"";position:fixed;inset:0;background:radial-gradient(circle at center,rgba(199,167,94,.14) 0%,transparent 60%);opacity:.05;animation:breath 12s ease-in-out infinite}
@keyframes drift{0%{transform:translate(0,0) scale(1)}100%{transform:translate(-3%,4%) scale(1.02)}}
@keyframes breath{0%,100%{opacity:.03}50%{opacity:.08}}
@keyframes pulse{0%,100%{transform:scale(1);opacity:.8}50%{transform:scale(1.05);opacity:1}}
@keyframes fade{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:translateY(0)}}
.app{display:flex;flex-direction:column;height:100vh}
header{border-bottom:1px solid var(--line);padding:14px 20px;display:flex;align-items:center;gap:12px}
h1{margin:0;color:var(--gold);font:600 13px/1 "Playfair Display",serif;letter-spacing:.15em;text-transform:uppercase}
.sub{color:var(--muted);font-size:11px;letter-spacing:.05em;margin-left:8px}
.user{margin-left:auto;padding:6px 14px;border-radius:16px;background:rgba(199,167,94,.12);color:var(--gold);font-size:12px;font-weight:600}
#chat{flex:1;overflow-y:auto;padding:28px 20px;position:relative}
.msg{max-width:720px;margin:0 auto 22px;animation:fade .3s ease;position:relative}
.user-msg{text-align:right}.user-msg .bubble{display:inline-block;padding:12px 18px;border-radius:18px 18px 4px 18px;background:rgba(199,167,94,.15);border:1px solid rgba(199,167,94,.25);color:var(--text)}
.ai-msg{text-align:left}.ai-msg .bubble{display:inline-block;padding:12px 18px;border-radius:18px 18px 18px 4px;background:#12121A;border:1px solid var(--line);color:var(--text);max-width:100%}
.ai-msg .bubble p{margin:0 0 .8em}
.ai-msg .bubble p:last-child{margin:0}
.ai-msg .bubble code{background:rgba(199,167,94,.1);padding:2px 6px;border-radius:4px;font-family:monospace;font-size:13px;color:var(--gold)}
.ai-msg .bubble pre{background:#0A0A12;padding:12px;border-radius:8px;overflow-x:auto;margin:10px 0}
.ai-msg .bubble pre code{background:none;padding:0;color:var(--text)}
.ai-msg .bubble strong{color:var(--gold)}
.def{border-bottom:1px dotted rgba(199,167,94,.6);cursor:help;position:relative}
.def:hover::after{content:attr(data-def);position:absolute;left:0;bottom:135%;background:#12121A;color:var(--text);border:1px solid rgba(199,167,94,.35);padding:8px 10px;border-radius:8px;white-space:nowrap;font-size:12px;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,.3)}
.thinking{position:absolute;left:4%;top:20%;height:60%;width:2px;background:linear-gradient(to bottom,transparent 0%,rgba(199,167,94,.6) 35%,rgba(199,167,94,.9) 50%,rgba(199,167,94,.6) 65%,transparent 100%);opacity:0;transition:opacity .3s ease}
.thinking.active{opacity:1;animation:pulse 2.4s ease-in-out infinite}
#suggest{max-width:720px;margin:0 auto 18px;text-align:center;min-height:28px;opacity:.7;transition:opacity .3s}
.sug-btn{display:inline-block;margin:4px;padding:7px 14px;border:1px solid rgba(199,167,94,.3);border-radius:14px;background:rgba(199,167,94,.08);color:var(--muted);font-size:12px;cursor:pointer;transition:all .2s}
.sug-btn:hover{background:rgba(199,167,94,.18);color:var(--gold);border-color:var(--gold);transform:translateY(-1px)}
footer{border-top:1px solid var(--line);padding:16px 20px;display:flex;gap:12px;align-items:center}
#input{flex:1;padding:12px 16px;border:1px solid var(--line);border-radius:12px;background:#12121A;color:var(--text);font:14px Inter,sans-serif;resize:none;max-height:120px}
#input:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px rgba(199,167,94,.15)}
button{padding:12px 20px;border:none;border-radius:12px;background:var(--gold);color:var(--bg-0);font-weight:700;cursor:pointer;transition:all .2s}
button:hover{background:var(--gold-2);transform:translateY(-1px)}
button:disabled{opacity:.4;cursor:not-allowed;transform:none}
aside{position:fixed;right:0;top:0;width:280px;height:100vh;background:#12121A;border-left:1px solid var(--line);display:flex;flex-direction:column;z-index:5}
.side-head{padding:18px;border-bottom:1px solid var(--line)}
.side-head h2{margin:0;font:600 12px/1 "Playfair Display",serif;color:var(--gold);letter-spacing:.1em;text-transform:uppercase}
.side-head p{margin:4px 0 0;font-size:10px;color:var(--muted);letter-spacing:.05em}
.journal{flex:1;overflow-y:auto;padding:14px}
.j-item{padding:10px;margin-bottom:8px;background:rgba(199,167,94,.06);border-left:2px solid var(--gold);border-radius:6px;cursor:pointer;transition:all .2s}
.j-item:hover{background:rgba(199,167,94,.12);border-left-color:var(--gold-2);transform:translateX(3px)}
.j-cat{font-size:9px;color:var(--gold);font-weight:700;letter-spacing:.08em;text-transform:uppercase;margin-bottom:4px}
.j-title{font-size:12px;color:var(--text);line-height:1.4}
.side-foot{padding:14px;border-top:1px solid var(--line)}
.side-foot a{display:block;padding:10px;text-align:center;background:rgba(199,167,94,.15);color:var(--gold);border-radius:8px;text-decoration:none;font-size:12px;font-weight:600;transition:all .2s}
.side-foot a:hover{background:var(--gold);color:var(--bg-0)}
@media(max-width:1024px){aside{display:none}}
audio{display:none}
.cite-box{margin-top:14px;padding-top:12px;border-top:1px solid var(--line);font-size:11px}
.cite-box h4{margin:0 0 8px;font-size:10px;color:var(--gold);letter-spacing:.1em;text-transform:uppercase}
.cite-item{padding:8px 10px;margin:4px 0;background:rgba(199,167,94,.08);border-left:2px solid var(--gold);border-radius:4px;color:var(--muted);transition:all .2s}
.cite-item:hover{background:rgba(199,167,94,.14);border-left-color:var(--gold-2)}
</style>
</head>
<body>
<div id="bg"></div>
<div class="app">
<header>
<h1>ZANTARA</h1><span class="sub">From Zero to Infinity ∞</span>
<div class="user" id="userName">Team</div>
</header>

<div class="thinking" id="thinking"></div>
<div id="chat">
<div class="msg ai-msg">
<div class="bubble">
<strong style="color:var(--gold)">🪷 Welcome to the Living Room</strong><br>
I'm ZANTARA—the intelligence behind Bali Zero. Ask me about <span class="def" data-def="C1: Consultation Visit">C1</span>, <span class="def" data-def="D12: Investor Residence Permit">D12</span>, <span class="def" data-def="E33G: Second Home Visa">E33G</span>, property investment, or business setup.
</div>
</div>
</div>

<div id="suggest"></div>

<footer>
<textarea id="input" placeholder="Ask me anything about Bali..." rows="1"></textarea>
<button id="send">Send →</button>
</footer>
</div>

<aside>
<div class="side-head">
<h2>📰 Tools</h2>
<p>Bali Zero Journal</p>
</div>
<div class="journal">
<div class="j-item" onclick="window.open('https://balizero.com/journal','_blank')">
<div class="j-cat">IMMIGRATION</div>
<div class="j-title">Latest visa updates and regulation changes</div>
</div>
<div class="j-item" onclick="window.open('https://balizero.com/journal','_blank')">
<div class="j-cat">BUSINESS</div>
<div class="j-title">Company formation insights and trends</div>
</div>
<div class="j-item" onclick="window.open('https://balizero.com/journal','_blank')">
<div class="j-cat">TAX & LEGAL</div>
<div class="j-title">Tax compliance and legal updates</div>
</div>
<div class="j-item" onclick="window.open('https://balizero.com/journal','_blank')">
<div class="j-cat">INSIGHTS</div>
<div class="j-title">Market analysis and intelligence</div>
</div>
</div>
<div class="side-foot">
<a href="https://balizero.com/journal" target="_blank">View Full Journal →</a>
</div>
</aside>

<audio id="breath" src="assets/infinity_breath.mp3" preload="auto"></audio>

<script>
// Auth guard
if(!ZANTARA_API.isLoggedIn()){window.location.href='login.html'}
const user=ZANTARA_API.getUser();
if(user)document.getElementById('userName').textContent=user.name;

const chatDiv=document.getElementById('chat');
const input=document.getElementById('input');
const sendBtn=document.getElementById('send');
const thinking=document.getElementById('thinking');
const breath=document.getElementById('breath');
const suggestDiv=document.getElementById('suggest');

// Markdown config
if(typeof marked!=='undefined'){
  marked.setOptions({breaks:true,gfm:true});
}

function renderMarkdown(text){
  if(typeof marked!=='undefined'){
    return marked.parse(text);
  }
  return text.replace(/\n/g,'<br>');
}

function append(text,role){
  const msg=document.createElement('div');
  msg.className=`msg ${role}-msg`;
  const bubble=document.createElement('div');
  bubble.className='bubble';
  if(role==='user'){
    bubble.textContent=text;
  }else{
    bubble.innerHTML=renderMarkdown(text);
  }
  msg.appendChild(bubble);
  chatDiv.appendChild(msg);
  chatDiv.scrollTop=chatDiv.scrollHeight;
  return msg;
}

function setThinking(active){
  thinking.classList.toggle('active',active);
  if(active){
    try{breath.volume=.15;breath.play()}catch(e){}
  }else{
    try{breath.pause();breath.currentTime=0}catch(e){}
  }
}

// Suggestions
const suggestions=[
  "What's the difference between D12 and E33G?",
  "How do I open a PT PMA in Bali?",
  "What are the property investment requirements?",
  "Tell me about the latest visa regulations",
  "What taxes apply to foreign investors?"
];
let currentSug=0;
function cycleSuggestions(){
  if(chatDiv.children.length>1)return; // Only show on empty chat
  suggestDiv.innerHTML='';
  for(let i=0;i<3;i++){
    const idx=(currentSug+i)%suggestions.length;
    const btn=document.createElement('span');
    btn.className='sug-btn';
    btn.textContent=suggestions[idx];
    btn.onclick=()=>{input.value=suggestions[idx];handleSend()};
    suggestDiv.appendChild(btn);
  }
  currentSug=(currentSug+1)%suggestions.length;
}
setInterval(cycleSuggestions,8000);
cycleSuggestions();

async function handleSend(){
  const t=input.value.trim();if(!t)return;
  append(t,'user');
  input.value='';
  sendBtn.disabled=true;
  setThinking(true);
  suggestDiv.innerHTML='';

  const userEmail=localStorage.getItem('zantara-email')||user?.email||'';

  // Try SSE streaming first
  if(window.ZANTARA_SSE&&window.ZANTARA_SSE.stream){
    const aiMsg=append('⏳ Thinking...','ai');
    const contentDiv=aiMsg.querySelector('.bubble');

    window.ZANTARA_SSE.on('start',()=>{
      contentDiv.innerHTML='';
    });

    window.ZANTARA_SSE.on('delta',({message:chunk})=>{
      contentDiv.innerHTML=renderMarkdown(chunk);
      chatDiv.scrollTop=chatDiv.scrollHeight;
    });

    window.ZANTARA_SSE.on('complete',({message:fullMessage,sources})=>{
      contentDiv.innerHTML=renderMarkdown(fullMessage);

      // Add citations if available
      if(sources&&sources.length>0){
        const citeBox=document.createElement('div');
        citeBox.className='cite-box';
        citeBox.innerHTML='<h4>Sources</h4>';
        sources.slice(0,3).forEach(s=>{
          const item=document.createElement('div');
          item.className='cite-item';
          item.textContent=`${s.source} (${s.tier||'Intel'})`;
          citeBox.appendChild(item);
        });
        contentDiv.appendChild(citeBox);
      }

      setThinking(false);
      sendBtn.disabled=false;
      chatDiv.scrollTop=chatDiv.scrollHeight;
    });

    window.ZANTARA_SSE.on('error',(error)=>{
      console.error('SSE Error:',error);
      contentDiv.innerHTML='<em style="color:#ef4444">Unable to respond. Please try again.</em>';
      setThinking(false);
      sendBtn.disabled=false;
    });

    await window.ZANTARA_SSE.stream(t,userEmail);

  }else{
    // Fallback to regular API
    try{
      const response=await ZANTARA_API.chat(t,userEmail);
      if(response.success){
        const aiMsg=append(response.response,'ai');

        // Add citations if available
        if(response.sources&&response.sources.length>0){
          const contentDiv=aiMsg.querySelector('.bubble');
          const citeBox=document.createElement('div');
          citeBox.className='cite-box';
          citeBox.innerHTML='<h4>Sources</h4>';
          response.sources.slice(0,3).forEach(s=>{
            const item=document.createElement('div');
            item.className='cite-item';
            item.textContent=`${s.source} (${s.tier||'Intel'})`;
            citeBox.appendChild(item);
          });
          contentDiv.appendChild(citeBox);
        }
      }else{
        append('Unable to respond. Please try again.','ai');
      }
    }catch(error){
      console.error('API Error:',error);
      append('Error connecting to ZANTARA. Please check your connection.','ai');
    }
    setThinking(false);
    sendBtn.disabled=false;
  }
}

sendBtn.addEventListener('click',handleSend);
input.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){
    e.preventDefault();
    handleSend();
  }
});

// Auto-resize textarea
input.addEventListener('input',function(){
  this.style.height='auto';
  this.style.height=Math.min(this.scrollHeight,120)+'px';
});
</script>
</body>
</html>
